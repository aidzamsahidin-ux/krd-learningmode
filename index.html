<!doctype html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Meta Tags -->
    <title>CirculoX</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CirculoX">
    <meta name="theme-color" content="#4f46e5">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700;900&display=swap');

        :root {
            --primary: #312e81; 
            --accent: #4f46e5;
            --bg-gradient: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: #111827;
            -webkit-tap-highlight-color: transparent;
        }

        @media (min-width: 1024px) {
            body { height: 100vh; overflow: hidden; }
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
        }

        .mnl-active {
            background: var(--accent) !important;
            color: white !important;
            transform: scale(1.15);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
            z-index: 10;
        }

        .mnl-item { width: 2.5rem; height: 2.5rem; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        @media (min-width: 1024px) {
            .mnl-item { width: 4.5rem; height: 4.5rem; border-width: 3px; }
            .mnl-item span:first-child { font-size: 1.5rem !important; }
            .mnl-item span:last-child { font-size: 0.75rem !important; }
        }

        .step-box {
            border-left: 6px solid var(--accent); background: #ffffff; padding: 1rem;
            border-radius: 1rem; margin-bottom: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .wheel-label, .ans-label { pointer-events: none; font-weight: 800; }
        .sector-highlight { stroke: var(--accent); stroke-width: 5px; fill: #e0e7ff !important; }

        .lcd-timer {
            font-size: clamp(5rem, 18vw, 16rem); line-height: 0.9; font-weight: 900; color: #ffffff;
            text-shadow: 0 4px 30px rgba(0,0,0,0.3); letter-spacing: -0.05em;
        }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        @media print {
            body > *:not(#printArea) { display: none !important; }
            #printArea { display: block !important; position: absolute; left: 0; top: 0; width: 100%; background: white; z-index: 9999; }
            .page-break { page-break-after: always; display: block; height: 100vh; position: relative; padding: 20px; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }

        #reader, #remoteScannerVideo { width: 100% !important; border-radius: 1.5rem; overflow: hidden; }
        
        .leaderboard-item { transition: all 0.5s ease-out; transform: translateY(20px); opacity: 0; }
        .leaderboard-item.show { transform: translateY(0); opacity: 1; }
    </style>
</head>
<body class="flex flex-col text-sm md:text-base">

    <!-- Header -->
    <header class="flex justify-between items-center p-3 md:p-4 no-print shrink-0 bg-white/60 backdrop-blur-md border-b border-indigo-100 z-10 sticky top-0">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white font-black text-xl shadow-lg">C</div>
            <div>
                <h1 class="text-xl md:text-2xl font-black text-indigo-900 leading-none">CirculoX</h1>
                <p class="text-[10px] font-bold text-indigo-400 uppercase tracking-wider">Versi Sekolah 3.0</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="openLCDMode()" class="p-2.5 bg-indigo-900 text-white rounded-xl shadow-lg hover:bg-black transition-all flex items-center gap-2">
                <span class="text-lg">üñ•Ô∏è</span> <span class="hidden md:inline font-bold">LCD</span>
            </button>
            <button onclick="openStudentManager()" class="p-2.5 bg-emerald-600 text-white rounded-xl shadow-lg hover:bg-emerald-700 transition-all flex items-center gap-2">
                <span class="text-lg">üë•</span> <span class="hidden md:inline font-bold">Rekod</span>
            </button>
            <button onclick="toggleScanner()" class="p-2.5 bg-amber-500 text-white rounded-xl shadow-lg hover:bg-amber-600 transition-all flex items-center gap-2">
                <span class="text-lg">üì∑</span> <span class="hidden md:inline font-bold">Imbas</span>
            </button>
        </div>
    </header>

    <!-- Main Workspace -->
    <main class="flex-grow flex flex-col lg:grid lg:grid-cols-12 gap-4 p-3 md:p-6 lg:overflow-hidden no-print">
        <!-- (Kandungan Utama Kekal Sama Seperti Sebelum Ini) -->
        <!-- Left: Controls -->
        <aside class="lg:col-span-3 flex flex-col gap-4 lg:overflow-hidden">
            <div class="glass-card p-5 rounded-[2rem] border-b-4 border-indigo-500">
                <div class="space-y-3">
                    <label class="text-[10px] font-black text-indigo-400 uppercase tracking-widest pl-1">Tetapan Murid</label>
                    <select id="classDropdown" onchange="loadStudentsByClass()" class="w-full bg-indigo-50/50 border-2 border-indigo-100 rounded-xl px-4 py-2.5 font-bold text-indigo-900 text-sm outline-none focus:border-indigo-500 transition-colors">
                        <option value="">Pilih Kelas...</option>
                    </select>
                    <select id="studentDropdown" onchange="selectStudentFromList()" class="w-full bg-white border-2 border-gray-100 rounded-xl px-4 py-2.5 font-bold text-gray-700 text-sm outline-none focus:border-indigo-500 transition-colors">
                        <option value="">Pilih Murid...</option>
                    </select>
                </div>
                <div id="activeStudentInfo" class="mt-4 pt-4 border-t border-dashed border-indigo-200 hidden">
                    <p class="text-[10px] font-black text-indigo-400 uppercase tracking-widest mb-1">Sedang Aktif</p>
                    <div id="studentDetail">
                        <p id="dispName" class="text-lg font-black text-indigo-900 leading-tight truncate"></p>
                        <p id="dispClass" class="text-xs font-bold text-indigo-500"></p>
                    </div>
                </div>
            </div>

            <div class="glass-card p-5 rounded-[2rem] lg:flex-grow lg:overflow-y-auto custom-scroll space-y-6">
                <div>
                    <h3 class="text-[10px] font-black text-gray-400 uppercase mb-2 tracking-widest">Mod Interaksi</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="setMode('learn')" id="btnLearn" class="py-3 rounded-xl font-bold text-sm border-2 border-indigo-600 bg-indigo-600 text-white shadow-lg transition-transform active:scale-95">Belajar</button>
                        <button onclick="setMode('practice')" id="btnPractice" class="py-3 rounded-xl font-bold text-sm border-2 border-indigo-100 text-indigo-900 hover:bg-indigo-50 transition-transform active:scale-95">Latihan</button>
                    </div>
                </div>
                <div>
                    <h3 class="text-[10px] font-black text-gray-400 uppercase mb-2 tracking-widest">Pilih Sifir</h3>
                    <div class="grid grid-cols-3 gap-2">
                        <script>
                            for(let i=1; i<=9; i++) document.write(`<button onclick="selectSifir(${i})" id="sifir-${i}" class="sifir-btn h-12 rounded-xl font-black text-lg border-2 border-gray-100 bg-white hover:border-indigo-400 text-gray-600 transition-all hover:-translate-y-0.5">${i}</button>`);
                        </script>
                    </div>
                </div>
                <div id="scoreCard" class="hidden bg-white p-4 rounded-2xl border-2 border-emerald-100 border-b-4 border-b-emerald-500">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-black text-emerald-800 text-xs uppercase tracking-wider">Skor</span>
                        <span class="text-2xl font-black text-emerald-600" id="currentScore">0/0</span>
                    </div>
                    <div class="flex justify-between items-center bg-emerald-50 p-2 rounded-lg">
                        <span class="text-[10px] font-black text-emerald-700">MASA</span>
                        <span class="text-lg font-mono font-black text-emerald-800" id="timerDisplay">00:00</span>
                    </div>
                </div>
                <button onclick="resetApp()" class="w-full py-2 text-gray-400 font-bold text-[10px] uppercase hover:text-red-500 transition-colors">Reset Sesi</button>
            </div>
        </aside>

        <!-- Center: Visualization -->
        <article class="lg:col-span-5 flex flex-col gap-4 lg:overflow-hidden relative">
            <div class="glass-card p-4 rounded-[2rem] border-t-4 border-indigo-600 overflow-x-auto custom-scroll shrink-0">
                <h3 class="text-center font-black text-indigo-900 mb-3 text-[10px] uppercase tracking-widest">Garis Nombor Ajaib</h3>
                <div class="flex justify-between items-center gap-2 md:px-2 min-w-[350px] lg:min-w-0">
                    <script>
                        const mnlArr = ["+1", "+2", "+3", "+4", "¬±5", "-4", "-3", "-2", "-1"];
                        for(let i=1; i<=9; i++) {
                            document.write(`<div id="mnl-${i}" class="mnl-item rounded-full bg-white border-2 border-gray-200 flex flex-col items-center justify-center transition-all shrink-0 shadow-sm"><span class="text-xs md:text-sm font-black text-indigo-900">${i}</span><span class="text-[8px] md:text-[10px] font-bold text-indigo-500">${mnlArr[i-1]}</span></div>`);
                        }
                    </script>
                </div>
            </div>
            <div class="flex-grow flex items-center justify-center p-4 min-h-[300px]">
                <div id="wheelWrapper" class="relative w-full aspect-square max-w-[420px] bg-white rounded-full shadow-2xl border-4 border-dashed border-indigo-100 flex items-center justify-center mx-auto transition-transform duration-500">
                    <span class="text-gray-300 font-black text-center p-10 text-xl uppercase tracking-widest">Pilih Sifir</span>
                </div>
            </div>
        </article>

        <!-- Right: Guide -->
        <aside class="lg:col-span-4 flex flex-col lg:overflow-hidden">
            <div id="guidePanel" class="glass-card p-6 rounded-[2rem] flex flex-col border-l-8 border-indigo-800 shadow-xl h-full lg:overflow-hidden">
                <div id="guideContent" class="flex-grow lg:overflow-y-auto custom-scroll pr-2">
                    <div class="text-center py-10 opacity-60">
                        <div class="text-6xl mb-4">üí°</div>
                        <h2 class="text-xl font-black text-indigo-900 mb-2">Panduan PdP</h2>
                        <p class="text-sm text-gray-500 font-bold">Pilih murid dan sifir untuk memulakan sesi interaktif.</p>
                    </div>
                </div>
                <div id="guideActions" class="mt-4 flex flex-col gap-3 shrink-0"></div>
            </div>
        </aside>
    </main>

    <!-- LCD / Countdown Mode (Host) -->
    <div id="lcdModal" class="fixed inset-0 bg-indigo-950 hidden z-[100] flex flex-col items-center justify-center p-6 text-center">
        <!-- Top Bar with Connection Info -->
        <div class="absolute top-6 left-6 right-6 flex justify-between items-start">
            <div class="text-left bg-indigo-900/50 p-4 rounded-2xl backdrop-blur-sm border border-indigo-700 flex gap-4">
                <div id="hostQrContainer" class="bg-white p-2 rounded-lg w-24 h-24 flex items-center justify-center"></div>
                <div>
                    <p class="text-indigo-300 text-xs font-bold uppercase tracking-wider mb-1">Untuk Telefon Guru</p>
                    <p class="text-white font-black text-lg leading-tight">Imbas Untuk<br>Remote Scan</p>
                    <p id="peerIdDisplay" class="text-xs text-indigo-400 font-mono mt-2 select-all cursor-pointer">ID: ...</p>
                </div>
            </div>
            
            <div class="flex flex-col items-end gap-2">
                <button onclick="closeLCDMode()" class="text-indigo-400 hover:text-white text-4xl font-black transition-colors">√ó</button>
                <div class="flex items-center gap-2">
                    <label class="text-indigo-300 text-xs font-bold uppercase">Pilih Kelas:</label>
                    <select id="lcdClassFilter" onchange="filterLeaderboard()" class="bg-indigo-900 text-white border border-indigo-600 rounded-lg px-3 py-1 font-bold text-sm outline-none">
                        <option value="all">SEMUA</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Timer Center -->
        <div class="flex flex-col items-center justify-center mt-10">
            <h2 class="text-indigo-300 text-2xl md:text-4xl font-black uppercase tracking-[0.3em] mb-4 opacity-80 animate-pulse">Masa Berjalan</h2>
            <div class="lcd-timer font-mono leading-none" id="lcdTimerDisplay">10:00</div>
            
            <div class="mt-8 flex items-center gap-4 bg-indigo-900/40 p-2 rounded-2xl backdrop-blur-sm">
                <select id="lcdTimeSelect" class="bg-transparent text-white text-xl font-black outline-none cursor-pointer px-4 py-2 border-r border-indigo-700">
                    <option value="300" class="bg-indigo-900">5 Minit</option>
                    <option value="600" class="bg-indigo-900" selected>10 Minit</option>
                    <option value="900" class="bg-indigo-900">15 Minit</option>
                    <option value="custom" class="bg-indigo-900">Custom...</option>
                </select>
                <input type="number" id="lcdCustomTime" class="w-16 bg-white/10 text-white font-black text-center rounded-lg px-2 py-1 outline-none hidden" placeholder="Min">
                
                <div class="flex gap-2">
                    <button onclick="startLcdCountdown()" id="lcdStartBtn" class="px-8 py-3 bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl font-black text-lg transition-all shadow-lg active:scale-95">MULA</button>
                    <button onclick="resetLcdCountdown()" class="px-6 py-3 bg-indigo-700 hover:bg-indigo-600 text-indigo-100 rounded-xl font-black text-lg transition-all">RESET</button>
                </div>
            </div>
        </div>

        <!-- Live Leaderboard -->
        <div class="absolute bottom-6 left-6 right-6 h-1/3 bg-indigo-900/30 rounded-[2rem] border border-indigo-800 backdrop-blur-md overflow-hidden flex flex-col p-6">
            <div class="flex justify-between items-center mb-4 border-b border-indigo-700/50 pb-2">
                <h3 class="text-white font-black text-xl uppercase tracking-widest flex items-center gap-2">
                    üèÜ Ranking Terpantas <span id="leaderboardCount" class="bg-indigo-600 px-2 py-0.5 rounded text-xs">0</span>
                </h3>
            </div>
            <div id="lcdLeaderboardList" class="flex-grow overflow-y-auto space-y-2 pr-2 custom-scroll">
                <p class="text-indigo-400/50 font-bold text-center mt-10 uppercase tracking-widest">Menunggu guru mengimbas...</p>
            </div>
        </div>
    </div>

    <!-- Remote Scanner Mode (Teacher Phone View) -->
    <div id="remoteScannerModal" class="fixed inset-0 bg-gray-900 hidden z-[120] flex flex-col items-center justify-center p-6 text-center">
        <h2 class="text-2xl font-black text-white mb-4 uppercase tracking-widest text-emerald-400 animate-pulse">‚Ä¢ LIVE CONNECTION ‚Ä¢</h2>
        <div class="w-full max-w-sm bg-black rounded-3xl overflow-hidden border-4 border-emerald-500 relative shadow-2xl">
            <div id="remoteScannerVideo" class="w-full h-64 bg-gray-800"></div>
            <div class="absolute top-4 left-4 bg-black/50 px-3 py-1 rounded-full text-xs font-bold text-white">MOD PENGIMBAS GURU</div>
        </div>
        <p class="mt-6 text-gray-400 font-bold text-sm px-6">Imbas kertas murid yang telah siap. Data akan dihantar terus ke skrin LCD.</p>
        <button onclick="stopRemoteScanner()" class="mt-8 py-4 px-12 bg-red-600 text-white rounded-2xl font-black text-xl shadow-lg active:scale-95 transition-transform">TUTUP</button>
    </div>

    <!-- Database & Scanner Modals -->
    <div id="studentModal" class="fixed inset-0 bg-black/90 backdrop-blur-xl hidden z-50 flex flex-col items-center justify-center p-4">
        <div class="glass-card w-full max-w-6xl p-6 md:p-8 rounded-[3rem] max-h-[95vh] flex flex-col overflow-hidden">
            <div class="flex justify-between items-center mb-4 px-2">
                <h2 class="text-3xl font-black text-pdp-primary">Pengurusan Data</h2>
                <button onclick="closeStudentManager()" class="text-gray-400 hover:text-red-600 text-4xl font-black">√ó</button>
            </div>
            <div class="flex gap-3 mb-6 px-2 overflow-x-auto">
                <button onclick="exportDatabase()" class="flex-1 py-3 bg-blue-50 text-blue-700 border border-blue-200 rounded-xl font-black text-xs uppercase whitespace-nowrap px-4">Simpan Data</button>
                <button onclick="triggerImport()" class="flex-1 py-3 bg-amber-50 text-amber-700 border border-amber-200 rounded-xl font-black text-xs uppercase whitespace-nowrap px-4">Muat Naik Data</button>
                <input type="file" id="importFile" class="hidden" accept=".json" onchange="importDatabase(this)">
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 overflow-hidden flex-grow px-2">
                <div class="space-y-6 overflow-y-auto custom-scroll pr-2">
                    <div class="p-6 bg-indigo-50 rounded-3xl border-2 border-indigo-100 space-y-4 shadow-sm">
                        <h3 class="font-black text-indigo-900 text-xs uppercase tracking-widest">Input Pukal</h3>
                        <textarea id="bulkInput" placeholder="Nama, Kelas (Satu per baris)" class="w-full h-32 px-5 py-4 rounded-2xl border-2 border-white outline-none font-bold text-sm resize-none"></textarea>
                        <button onclick="addBulkStudents()" class="w-full py-3.5 bg-indigo-700 text-white rounded-xl font-black text-sm">Simpan Pukal</button>
                    </div>
                    <div id="studentListContainer" class="space-y-2"></div>
                </div>
                <div class="bg-white border-4 border-indigo-50 rounded-[2.5rem] p-6 flex flex-col overflow-hidden">
                    <h3 class="font-black text-emerald-700 text-xs uppercase tracking-widest mb-2 text-center">Rekod & Cetak</h3>
                    <div class="bg-emerald-50 p-4 rounded-2xl mb-4 border border-emerald-100 flex gap-3">
                        <select id="printClassSelect" class="flex-1 px-4 py-3 rounded-xl border-2 border-emerald-200 font-bold text-emerald-900 outline-none text-sm bg-white"><option value="all">SEMUA KELAS</option></select>
                        <button onclick="generateTestByClass()" class="px-6 py-3 bg-emerald-600 text-white rounded-xl font-black whitespace-nowrap">CETAK PDF</button>
                    </div>
                    <div id="gradebookList" class="flex-grow overflow-y-auto custom-scroll space-y-3 pr-1"></div>
                    <button onclick="clearAllData()" class="mt-4 text-[10px] text-red-400 font-bold uppercase underline text-center">Padam Semua Data</button>
                </div>
            </div>
        </div>
    </div>

    <div id="scannerModal" class="fixed inset-0 bg-black/95 backdrop-blur-md hidden z-50 flex flex-col items-center justify-center p-6 text-center">
        <h2 class="text-3xl font-black text-white mb-8 uppercase tracking-widest">Imbas Kod</h2>
        <div id="reader" class="rounded-[2rem] overflow-hidden w-full max-w-sm border-4 border-indigo-600 bg-white"></div>
        <button onclick="toggleScanner()" class="mt-10 py-4 px-14 bg-white/10 text-white border border-white/20 rounded-2xl font-black text-lg">Tutup</button>
    </div>

    <div id="entryModal" class="fixed inset-0 bg-black/70 hidden z-[60] flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-md p-8 rounded-[3rem] animate-fade-up border-indigo-700 border-t-[15px] text-center shadow-2xl">
            <h2 class="text-2xl font-black text-indigo-900 mb-2">Rekod Markah</h2>
            <p id="entryStudentInfo" class="text-indigo-500 font-bold mb-8 text-sm uppercase tracking-wider"></p>
            <div class="space-y-8">
                <div><label class="block text-[10px] font-black text-gray-400 uppercase mb-4 text-left pl-1">Sifir</label><div class="grid grid-cols-5 gap-2" id="entrySifirGrid"></div></div>
                <div class="grid grid-cols-2 gap-6">
                    <div><label class="block text-[10px] font-black text-gray-400 uppercase mb-3 text-left pl-1">Betul</label><input type="number" id="entryScore" min="0" max="10" class="w-full px-5 py-4 rounded-2xl border-2 border-indigo-50 bg-indigo-50 font-black text-4xl text-center outline-none"></div>
                    <div><label class="block text-[10px] font-black text-gray-400 uppercase mb-3 text-left pl-1">Masa</label><input type="number" id="entryTime" placeholder="45" class="w-full px-5 py-4 rounded-2xl border-2 border-indigo-50 bg-indigo-50 font-black text-4xl text-center outline-none"></div>
                </div>
                <button onclick="saveEntry()" class="w-full py-5 bg-indigo-700 text-white rounded-2xl font-black text-xl">Simpan</button>
                <button onclick="closeEntryModal()" class="w-full py-2 text-gray-400 font-bold uppercase text-[10px]">Batal</button>
            </div>
        </div>
    </div>

    <!-- Print Area -->
    <div id="printArea" class="hidden bg-white"></div>

    <script>
        // --- Setup PWA & PeerJS ---
        const manifest = {name:"CirculoX",short_name:"CirculoX",start_url:".",display:"standalone",background_color:"#e0e7ff",theme_color:"#4f46e5",icons:[{src:"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0iIzRmNDZlNSIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTYwIiBmaWxsPSJ3aGl0ZSIvPjxwYXRoIGQ9Ik0yNTYgMTYwdjE5Mm0tOTYtOTZoMTkyIiBzdHJva2U9IiM0ZjQ2ZTUiIHN0cm9rZS13aWR0aD0iNDAiLz48L3N2Zz4=",sizes:"192x192",type:"image/png"}]};
        const manifestLink = document.createElement('link'); manifestLink.rel = 'manifest'; manifestLink.href = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type:'application/json'})); document.head.appendChild(manifestLink);

        let peer = null;
        let conn = null;
        let myPeerId = null;
        let raceStartTime = null;
        let liveLeaderboard = [];
        let remoteScannerHtml5QrCode = null;

        // --- Init State ---
        let currentSifir = null, currentMode = 'learn', lang = 'ms';
        let score = { correct: 0, total: 0 }, activeMultiplier = null, currentSubStep = 0;
        let timerInterval = null, timeElapsed = 0, html5QrCode = null;
        let students = JSON.parse(localStorage.getItem('krd_students_v3') || '[]');
        let records = JSON.parse(localStorage.getItem('krd_records_v3') || '[]');
        let activeStudent = null, scanTargetSifir = 1;
        let lcdCountdownInterval = null, lcdTimeLeft = 600;

        const krdActions = {
            1: { val: 1, type: 'plus', display: '+1' }, 2: { val: 2, type: 'plus', display: '+2' },
            3: { val: 3, type: 'plus', display: '+3' }, 4: { val: 4, type: 'plus', display: '+4' },
            5: { val: 5, type: 'both', display: '¬±5' }, 6: { val: 4, type: 'minus', display: '-4' },
            7: { val: 3, type: 'minus', display: '-3' }, 8: { val: 2, type: 'minus', display: '-2' },
            9: { val: 1, type: 'minus', display: '-1' }
        };

        // --- PeerJS / LCD Host Logic ---
        function openLCDMode() {
            document.getElementById('lcdModal').classList.remove('hidden');
            document.getElementById('lcdTimerDisplay').innerText = "10:00";
            
            // Init Peer for Host
            if(!peer) {
                peer = new Peer();
                peer.on('open', (id) => {
                    myPeerId = id;
                    document.getElementById('peerIdDisplay').innerText = `ID: ${id}`;
                    generateHostQR(id);
                });
                peer.on('connection', (c) => {
                    c.on('data', (data) => {
                        if(data.type === 'SCAN_ENTRY') {
                            handleRaceEntry(data.payload);
                        }
                    });
                });
            } else {
                generateHostQR(myPeerId);
            }
            
            // Populate class filter in LCD
            const classFilter = document.getElementById('lcdClassFilter');
            const unique = [...new Set(students.map(s => s.kls))].sort();
            classFilter.innerHTML = '<option value="all">SEMUA</option>' + unique.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function generateHostQR(id) {
            const container = document.getElementById('hostQrContainer');
            container.innerHTML = "";
            const joinData = JSON.stringify({ type: "CONNECT_REMOTE", hostId: id });
            new QRCode(container, {
                text: joinData,
                width: 80,
                height: 80
            });
        }

        function handleRaceEntry(payload) {
            // Calculate time taken based on countdown
            const totalTime = parseInt(document.getElementById('lcdTimeSelect').value) === 0 ? 600 : parseInt(document.getElementById('lcdTimeSelect').value);
            // If custom time used
            const selectedTime = document.getElementById('lcdTimeSelect').value;
            let initialTime = selectedTime === 'custom' ? (document.getElementById('lcdCustomTime').value * 60) : parseInt(selectedTime);
            
            // Current Time (Elapsed)
            const elapsed = initialTime - lcdTimeLeft;
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            const timeString = `${minutes}m ${seconds}s`;
            
            // Check if student already in leaderboard to prevent duplicates
            const exists = liveLeaderboard.find(r => r.name === payload.name && r.kls === payload.kls);
            if(exists) return; // Ignore duplicate scans

            liveLeaderboard.push({
                name: payload.name,
                kls: payload.kls,
                timeStr: timeString,
                timestamp: elapsed
            });
            
            updateLCDLeaderboardUI();
        }

        function updateLCDLeaderboardUI() {
            const list = document.getElementById('lcdLeaderboardList');
            const filter = document.getElementById('lcdClassFilter').value;
            let displayData = liveLeaderboard;
            
            if(filter !== 'all') {
                displayData = liveLeaderboard.filter(r => r.kls === filter);
            }
            
            // Sort by fastest time
            displayData.sort((a,b) => a.timestamp - b.timestamp);
            
            list.innerHTML = "";
            document.getElementById('leaderboardCount').innerText = displayData.length;
            
            displayData.forEach((r, idx) => {
                const el = document.createElement('div');
                el.className = "leaderboard-item show bg-white/10 p-3 rounded-xl flex justify-between items-center text-white";
                el.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-white text-indigo-900 font-black flex items-center justify-center">${idx + 1}</div>
                        <div>
                            <p class="font-bold leading-tight">${r.name}</p>
                            <p class="text-[10px] opacity-70">${r.kls}</p>
                        </div>
                    </div>
                    <p class="font-mono font-bold text-emerald-400 text-xl">${r.timeStr}</p>
                `;
                list.appendChild(el);
            });
        }

        function filterLeaderboard() {
            updateLCDLeaderboardUI();
        }

        function closeLCDMode() {
            document.getElementById('lcdModal').classList.add('hidden');
            resetLcdCountdown();
        }

        // --- Remote Scanner (Teacher Phone) Logic ---
        function startRemoteScanner(hostId) {
            document.getElementById('remoteScannerModal').classList.remove('hidden');
            
            // Connect to host
            if(!peer) peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect(hostId);
                conn.on('open', () => {
                    // Connection established, start camera
                    startHtml5RemoteScanner();
                });
            });
        }

        function startHtml5RemoteScanner() {
            remoteScannerHtml5QrCode = new Html5Qrcode("remoteScannerVideo");
            remoteScannerHtml5QrCode.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: 250 }, 
                (decodedText) => {
                    // Handle scanned student QR
                    if(decodedText.startsWith("LOGIN:")) {
                        const parts = decodedText.replace("LOGIN:", "").split("|");
                        const studentName = parts[0];
                        const studentClass = parts[1];
                        
                        if(conn && conn.open) {
                            conn.send({
                                type: 'SCAN_ENTRY',
                                payload: { name: studentName, kls: studentClass }
                            });
                            
                            // Visual feedback on phone
                            // Ideally, pause scanning briefly
                            remoteScannerHtml5QrCode.pause();
                            alert(`Data ${studentName} dihantar!`);
                            remoteScannerHtml5QrCode.resume();
                        } else {
                            alert("Terputus sambungan dengan LCD.");
                        }
                    }
                }
            ).catch(err => {
                console.log(err);
                alert("Ralat kamera remote.");
            });
        }

        function stopRemoteScanner() {
            if(remoteScannerHtml5QrCode) {
                remoteScannerHtml5QrCode.stop().then(() => {
                    document.getElementById('remoteScannerModal').classList.add('hidden');
                    remoteScannerHtml5QrCode = null;
                });
            } else {
                document.getElementById('remoteScannerModal').classList.add('hidden');
            }
        }

        // --- Scanner Logic (Main) ---
        function toggleScanner() { 
            const m = document.getElementById('scannerModal'); 
            if(!m.classList.contains('hidden')) { if(html5QrCode) html5QrCode.stop(); m.classList.add('hidden'); }
            else { 
                m.classList.remove('hidden'); html5QrCode = new Html5Qrcode("reader"); 
                html5QrCode.start({facingMode:"environment"}, {fps:10,qrbox:250}, (t)=>{ 
                    try {
                        // Check if it's a Remote Connect QR
                        if(t.includes("CONNECT_REMOTE")) {
                            const data = JSON.parse(t);
                            toggleScanner(); // Close main scanner
                            startRemoteScanner(data.hostId);
                            return;
                        }
                        // Check if it's Login QR
                        if(t.startsWith("LOGIN:")) { 
                            const p = t.replace("LOGIN:","").split("|"); 
                            activeStudent={name:p[0],kls:p[1]}; 
                            toggleScanner(); 
                            updateStudentUI();
                            return;
                        }
                    } catch(e) { console.log(e); }
                }); 
            }
        }

        // --- LCD Timer Logic ---
        function startLcdCountdown() {
            if(lcdCountdownInterval) { clearInterval(lcdCountdownInterval); lcdCountdownInterval = null; document.getElementById('lcdStartBtn').innerText = "SAMBUNG"; return; }
            
            const select = document.getElementById('lcdTimeSelect');
            if (select.value === 'custom') {
                const val = document.getElementById('lcdCustomTime').value;
                if(!val) return alert("Masukkan masa.");
                if(lcdTimeLeft === 600 || lcdTimeLeft === 0) lcdTimeLeft = val * 60;
            } else {
                if(lcdTimeLeft === 600 || lcdTimeLeft === 0) lcdTimeLeft = parseInt(select.value);
            }

            document.getElementById('lcdStartBtn').innerText = "BERHENTI";
            lcdCountdownInterval = setInterval(() => { 
                lcdTimeLeft--; 
                updateLcdDisplay(); 
                if(lcdTimeLeft <= 0) { 
                    clearInterval(lcdCountdownInterval); 
                    lcdCountdownInterval = null; 
                    alert("MASA TAMAT!"); 
                    resetLcdCountdown(); 
                } 
            }, 1000);
        }

        function resetLcdCountdown() { 
            clearInterval(lcdCountdownInterval); lcdCountdownInterval = null; lcdTimeLeft = 600; 
            document.getElementById('lcdTimerDisplay').innerText = "10:00"; 
            document.getElementById('lcdStartBtn').innerText = "MULA";
            liveLeaderboard = [];
            updateLCDLeaderboardUI();
        }

        function updateLcdDisplay() { 
            const m = Math.floor(lcdTimeLeft/60).toString().padStart(2, '0');
            const s = (lcdTimeLeft%60).toString().padStart(2, '0'); 
            document.getElementById('lcdTimerDisplay').innerText = `${m}:${s}`; 
        }

        document.getElementById('lcdTimeSelect').addEventListener('change', function() {
            const cust = document.getElementById('lcdCustomTime');
            if(this.value === 'custom') {
                cust.classList.remove('hidden');
            } else {
                cust.classList.add('hidden');
                lcdTimeLeft = parseInt(this.value);
                updateLcdDisplay();
            }
        });

        // --- Main App Logic (Existing) ---
        function updateClassDropdown() {
            const drop = document.getElementById('classDropdown'), printDrop = document.getElementById('printClassSelect');
            const unique = [...new Set(students.map(s => s.kls))].sort();
            const opts = unique.map(c => `<option value="${c}">${c}</option>`).join('');
            drop.innerHTML = '<option value="">Pilih Kelas...</option>' + opts;
            printDrop.innerHTML = '<option value="all">SEMUA KELAS</option>' + opts;
        }
        function loadStudentsByClass() {
            const kls = document.getElementById('classDropdown').value, drop = document.getElementById('studentDropdown');
            if(!kls) { drop.innerHTML = '<option value="">Pilih Murid...</option>'; return; }
            drop.innerHTML = '<option value="">Pilih Murid...</option>' + students.filter(s => s.kls === kls).sort((a,b)=>a.name.localeCompare(b.name)).map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        }
        function selectStudentFromList() {
            const name = document.getElementById('studentDropdown').value, kls = document.getElementById('classDropdown').value;
            if(!name) { activeStudent = null; updateStudentUI(); return; }
            activeStudent = students.find(s => s.name === name && s.kls === kls);
            updateStudentUI();
        }
        function updateStudentUI() {
            const d = document.getElementById('studentDetail'), p = document.getElementById('noStudentText'), i = document.getElementById('activeStudentInfo');
            if(activeStudent) { d.classList.remove('hidden'); p.classList.add('hidden'); i.classList.remove('hidden'); document.getElementById('dispName').innerText = activeStudent.name; document.getElementById('dispClass').innerText = activeStudent.kls; }
            else { d.classList.add('hidden'); p.classList.remove('hidden'); i.classList.add('hidden'); }
        }
        function addStudent() {
            const n = document.getElementById('addName').value.trim(), k = document.getElementById('addClass').value.trim().toUpperCase();
            if(!n || !k) return;
            students.push({ name: n, kls: k }); localStorage.setItem('krd_students_v3', JSON.stringify(students));
            document.getElementById('addName').value = ''; document.getElementById('addClass').value = '';
            updateClassDropdown(); renderStudentList();
        }
        function addBulkStudents() {
            const raw = document.getElementById('bulkInput').value; if(!raw) return;
            raw.split('\n').forEach(l => { const p = l.split(','); if(p.length>=2) students.push({name:p[0].trim(), kls:p[1].trim().toUpperCase()}); });
            localStorage.setItem('krd_students_v3', JSON.stringify(students));
            updateClassDropdown(); renderStudentList(); document.getElementById('bulkInput').value='';
        }
        function renderStudentList() {
            const l = document.getElementById('studentListContainer');
            l.innerHTML = students.length ? '' : '<p class="text-center text-gray-300 py-6 text-[10px]">TIADA DATA</p>';
            [...students].reverse().slice(0,50).forEach((s, idx) => {
                const d = document.createElement('div'); d.className = "flex justify-between p-3 bg-white border shadow-sm rounded-xl mb-2";
                d.innerHTML = `<div><p class="font-bold text-sm">${s.name}</p><p class="text-[10px] text-gray-500">${s.kls}</p></div><button onclick="removeStudent(${students.length-1-idx})" class="text-red-500 font-black">√ó</button>`;
                l.appendChild(d);
            });
        }
        function removeStudent(idx) { students.splice(idx, 1); localStorage.setItem('krd_students_v3', JSON.stringify(students)); updateClassDropdown(); renderStudentList(); }
        function renderGradebook() {
            const l = document.getElementById('gradebookList');
            l.innerHTML = records.length ? '' : '<p class="text-center text-gray-300 py-6 text-[10px]">TIADA REKOD</p>';
            [...records].reverse().forEach(r => {
                const d = document.createElement('div'); d.className = "p-3 bg-indigo-50 border rounded-xl mb-2";
                d.innerHTML = `<p class="font-bold text-xs">${r.name}</p><p class="text-[10px]">Sifir ${r.sifir} | Skor ${r.score} | ${r.time}s</p>`;
                l.appendChild(d);
            });
        }
        function clearAllData() { if(confirm("Padam semua?")) { students=[]; records=[]; localStorage.clear(); updateClassDropdown(); renderStudentList(); renderGradebook(); } }

        function setMode(mode) { currentMode = mode; document.getElementById('scoreCard').classList.toggle('hidden', mode === 'learn'); resetApp(); }
        function selectSifir(num) { 
            currentSifir = num; resetTimer(); 
            document.querySelectorAll('.sifir-btn').forEach(b => b.classList.remove('border-indigo-600', 'bg-indigo-100'));
            document.getElementById(`sifir-${num}`).classList.add('border-indigo-600', 'bg-indigo-100');
            renderWheel(num);
        }
        function renderWheel(num) {
            const w = document.getElementById('wheelWrapper'); w.innerHTML = '';
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg"); svg.setAttribute("viewBox", "0 0 400 400"); svg.classList.add("w-full","h-full");
            for(let i=0; i<10; i++) {
                const a = i*36-90, rad = ((a+18)*Math.PI)/180;
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", createArcPath(200,200,85,175,a,a+36));
                path.setAttribute("fill", "white"); path.setAttribute("stroke", "#e0e7ff"); path.setAttribute("stroke-width", "3");
                path.onclick = () => handleSegmentClick(i+1);
                
                const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
                txt.setAttribute("x", 200+Math.cos(rad)*65); txt.setAttribute("y", 200+Math.sin(rad)*65);
                txt.setAttribute("text-anchor", "middle"); txt.setAttribute("alignment-baseline", "middle");
                txt.textContent = i+1; txt.classList.add("font-black", "fill-indigo-900", "pointer-events-none");
                
                const ans = document.createElementNS("http://www.w3.org/2000/svg", "text");
                ans.setAttribute("x", 200+Math.cos(rad)*135); ans.setAttribute("y", 200+Math.sin(rad)*135+5);
                ans.setAttribute("text-anchor", "middle");
                ans.textContent = "??"; ans.id = `ans-${i+1}`; ans.classList.add("font-bold", "fill-gray-300", "pointer-events-none");
                
                svg.append(path, txt, ans);
            }
            const c = document.createElementNS("http://www.w3.org/2000/svg", "circle"); c.setAttribute("cx",200); c.setAttribute("cy",200); c.setAttribute("r",40); c.setAttribute("fill","#4f46e5");
            const ct = document.createElementNS("http://www.w3.org/2000/svg", "text"); ct.setAttribute("x",200); ct.setAttribute("y",206); ct.setAttribute("text-anchor","middle"); ct.setAttribute("fill","white"); ct.textContent = `${num}√ó`; ct.classList.add("font-black","text-2xl");
            svg.append(c, ct); w.appendChild(svg);
        }
        function handleSegmentClick(m) {
            if(currentMode==='practice' && !timerInterval && score.total===0) startTimer();
            activeMultiplier = m; currentSubStep = 1; updateLearnUI();
        }
        function updateLearnUI() {
            const res = currentSifir * activeMultiplier;
            const ans = document.getElementById(`ans-${activeMultiplier}`);
            if(currentMode === 'learn') {
                ans.textContent = res; ans.classList.replace('fill-gray-300','fill-indigo-900');
            } else {
                const userAns = prompt("Jawapan?");
                if(parseInt(userAns) === res) { ans.textContent = res; ans.classList.replace('fill-gray-300','fill-emerald-600'); score.correct++; }
                score.total++; document.getElementById('currentScore').innerText = `${score.correct}/${score.total}`;
            }
        }
        function createArcPath(x,y,r1,r2,a1,a2) {
            const rad1=a1*Math.PI/180, rad2=a2*Math.PI/180;
            return `M ${x+Math.cos(rad1)*r2} ${y+Math.sin(rad1)*r2} A ${r2} ${r2} 0 0 1 ${x+Math.cos(rad2)*r2} ${y+Math.sin(rad2)*r2} L ${x+Math.cos(rad2)*r1} ${y+Math.sin(rad2)*r1} A ${r1} ${r1} 0 0 0 ${x+Math.cos(rad1)*r1} ${y+Math.sin(rad1)*r1} Z`;
        }
        function startTimer() { if(!timerInterval) { const s = Date.now(); timerInterval = setInterval(() => { const t = Math.floor((Date.now()-s)/1000); document.getElementById('timerDisplay').innerText = t; }, 1000); } }
        function resetTimer() { clearInterval(timerInterval); timerInterval=null; if(document.getElementById('timerDisplay')) document.getElementById('timerDisplay').innerText="00:00"; }
        function resetApp() { currentSifir=null; score={correct:0,total:0}; resetTimer(); if(document.getElementById('wheelWrapper')) document.getElementById('wheelWrapper').innerHTML = `<span class="text-gray-300 font-black">Pilih Sifir</span>`; }
        
        function openStudentManager() { document.getElementById('studentModal').classList.remove('hidden'); renderStudentList(); renderGradebook(); }
        function closeStudentManager() { document.getElementById('studentModal').classList.add('hidden'); }
        
        function openEntryModal() { document.getElementById('entryModal').classList.remove('hidden'); if(activeStudent) document.getElementById('entryStudentInfo').innerText = `${activeStudent.name} (${activeStudent.kls})`; const g = document.getElementById('entrySifirGrid'); g.innerHTML=""; for(let i=1; i<=9; i++) { const b = document.createElement('button'); b.className = `p-2 rounded font-black border ${scanTargetSifir==i?'bg-indigo-600 text-white':'bg-white text-gray-600'}`; b.innerText=i; b.onclick=()=>{scanTargetSifir=i;openEntryModal();}; g.appendChild(b); } }
        function closeEntryModal() { document.getElementById('entryModal').classList.add('hidden'); }
        function saveEntry() { const sc=document.getElementById('entryScore').value; const tm=document.getElementById('entryTime').value; if(!sc||!tm) return; records.push({name:activeStudent.name,kls:activeStudent.kls,sifir:scanTargetSifir,score:sc,time:tm,date:new Date().toLocaleDateString()}); localStorage.setItem('krd_records_v3', JSON.stringify(records)); updateStudentUI(); renderGradebook(); closeEntryModal(); }

        function generateTestByClass() {
            const cls = document.getElementById('printClassSelect').value;
            const target = cls === 'all' ? students : students.filter(s => s.kls === cls);
            if(!target.length) return alert("Tiada data.");
            
            const p = document.getElementById('printArea'); 
            p.innerHTML = '';
            
            target.forEach((s, index) => {
                const qrId = `qrcode-${index}`;
                // Use a single A4 container
                const d = document.createElement('div');
                d.className = 'page-break bg-white p-8';
                
                let content = `
                <div class="border-4 border-gray-800 p-6 rounded-3xl h-full flex flex-col relative">
                    <div class="flex justify-between items-start border-b-4 border-black pb-4 mb-4">
                        <div>
                            <h1 class="text-4xl font-black mb-1 uppercase tracking-tighter">CIRCULOX</h1>
                            <p class="text-xl font-bold uppercase">${s.name}</p>
                            <p class="text-lg font-bold uppercase text-gray-600">${s.kls}</p>
                        </div>
                        <div class="flex flex-col items-center">
                            <div id="${qrId}" class="bg-white p-1 border-2 border-black"></div>
                            <p class="text-[10px] font-black mt-1 uppercase">Imbas Untuk Mula</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 flex-grow">
                `;
                
                // Add Sifir 2-9
                for(let i=2; i<=9; i++) {
                    content += `
                    <div class="border-2 border-gray-400 rounded-2xl p-2 flex flex-col items-center justify-center relative">
                        <p class="absolute top-1 left-2 font-black text-lg text-gray-300">x${i}</p>
                        <svg viewBox="0 0 400 400" class="w-32 h-32">
                            ${Array.from({length:10}, (_, j) => {
                                const a = j*36-90, rad = ((a+18)*Math.PI)/180;
                                return `<path d="${createArcPath(200,200,90,180,a,a+36)}" fill="none" stroke="black" stroke-width="6" />
                                        <text x="${200+Math.cos(rad)*65}" y="${200+Math.sin(rad)*65}" text-anchor="middle" font-size="28" font-weight="900" alignment-baseline="middle">${j+1}</text>
                                        <text x="${200+Math.cos(rad)*112}" y="${200+Math.sin(rad)*115}" text-anchor="middle" font-size="24" fill="#ccc">__</text>`;
                            }).join('')}
                            <circle cx="200" cy="200" r="45" fill="none" stroke="black" stroke-width="6" />
                        </svg>
                    </div>`;
                }
                
                content += `
                    </div>
                    <div class="mt-4 pt-2 border-t-4 border-black flex justify-between font-black text-lg">
                        <p>SKOR: _____ / 80</p>
                        <p>MASA: _________</p>
                    </div>
                </div>`;
                
                d.innerHTML = content;
                p.appendChild(d);
            });
            
            // Generate QR Codes with qrcode.js
            setTimeout(() => {
                target.forEach((s, index) => {
                    const el = document.getElementById(`qrcode-${index}`);
                    if(el) {
                        new QRCode(el, {
                            text: `LOGIN:${s.name}|${s.kls}`,
                            width: 80,
                            height: 80,
                            correctLevel: QRCode.CorrectLevel.L
                        });
                    }
                });
                // Delay print to ensure images render
                setTimeout(() => window.print(), 800);
            }, 100);
        }

        // Database
        function exportDatabase() {
            const data = { students, records, timestamp: new Date().toISOString() };
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(data)],{type:'application/json'}));
            a.download = "circulox_db.json"; document.body.appendChild(a); a.click(); a.remove();
        }
        function triggerImport() { document.getElementById('importFile').click(); }
        function importDatabase(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader(); r.onload=e=>{
                try { const d=JSON.parse(e.target.result); if(d.students){ students=d.students; records=d.records||[]; localStorage.setItem('krd_students_v3',JSON.stringify(students)); localStorage.setItem('krd_records_v3',JSON.stringify(records)); updateClassDropdown(); renderStudentList(); renderGradebook(); alert("Berjaya."); } } catch(e){alert("Ralat fail.");}
            }; r.readAsText(f);
        }

        // Init
        updateClassDropdown(); renderStudentList(); renderGradebook(); resetApp();
    </script>
</body>
</html>
