<!doctype html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Meta Tags -->
    <title>Kit Roda Darab PdP Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RodaDarab">
    <meta name="theme-color" content="#4f46e5">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap');

        :root {
            --primary: #4f46e5;
            --bg-gradient: linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 100%);
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: #1f2937;
            -webkit-tap-highlight-color: transparent;
        }

        /* Desktop Zero-Scroll Fix */
        @media (min-width: 1024px) {
            body {
                height: 100vh;
                overflow: hidden;
            }
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.96);
            backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 30px rgba(31, 38, 135, 0.08);
        }

        .mnl-active {
            background: var(--primary) !important;
            color: white !important;
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
            z-index: 10;
        }

        .step-box {
            border-left: 6px solid var(--primary);
            background: #ffffff;
            padding: 1rem;
            border-radius: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .wheel-label, .ans-label {
            pointer-events: none;
            font-weight: 900;
        }

        .sector-highlight {
            stroke: var(--primary);
            stroke-width: 6;
            fill: #f5f7ff !important;
        }

        /* LCD Mode Styles */
        .lcd-timer {
            font-size: clamp(4rem, 12vw, 12rem);
            line-height: 1;
            font-weight: 900;
        }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 10px; }

        @media print {
            body { overflow: auto !important; height: auto !important; }
            .no-print { display: none !important; }
            #printArea { display: block !important; }
        }

        #reader {
            width: 100% !important;
            border-radius: 1.5rem;
            overflow: hidden;
        }
    </style>
</head>
<body class="flex flex-col">

    <!-- Compact Header -->
    <header class="flex justify-between items-center p-3 md:p-4 no-print shrink-0">
        <div class="flex items-center gap-2">
            <h1 class="text-xl md:text-2xl font-black text-indigo-700 tracking-tighter">Kit Roda Darab</h1>
            <div class="hidden sm:flex px-2 py-1 bg-emerald-100 text-emerald-700 text-[9px] font-black rounded-full uppercase">Offline</div>
        </div>
        <div class="flex gap-2">
            <button onclick="openLCDMode()" class="p-2 bg-indigo-900 text-white rounded-xl shadow hover:bg-black transition-all">üñ•Ô∏è</button>
            <button onclick="openStudentManager()" class="p-2 bg-emerald-600 text-white rounded-xl shadow hover:bg-emerald-700 transition-all">üë•</button>
            <button onclick="toggleScanner()" class="p-2 bg-amber-500 text-white rounded-xl shadow hover:bg-amber-600 transition-all">üì∑</button>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-grow flex flex-col lg:grid lg:grid-cols-12 gap-3 p-3 md:p-4 lg:overflow-hidden no-print">
        
        <!-- Left Sidebar: Student & Config -->
        <aside class="lg:col-span-3 flex flex-col gap-3 lg:overflow-hidden">
            <!-- Student Selector -->
            <div class="glass-card p-4 rounded-3xl border-b-4 border-indigo-500">
                <div class="space-y-2">
                    <select id="classDropdown" onchange="loadStudentsByClass()" class="w-full bg-indigo-50 border-2 border-indigo-100 rounded-xl px-3 py-2 font-black text-indigo-700 text-sm">
                        <option value="">Pilih Kelas...</option>
                    </select>
                    <select id="studentDropdown" onchange="selectStudentFromList()" class="w-full bg-white border-2 border-gray-100 rounded-xl px-3 py-2 font-bold text-gray-700 text-sm">
                        <option value="">Pilih Murid...</option>
                    </select>
                </div>
                <div id="activeStudentInfo" class="mt-3 hidden">
                    <p class="text-[9px] font-black text-indigo-400 uppercase tracking-widest">Sesi Aktif</p>
                    <div id="studentDetail">
                        <p id="dispName" class="text-lg font-black text-indigo-800 truncate leading-tight"></p>
                        <p id="dispClass" class="text-xs font-bold text-indigo-400"></p>
                    </div>
                </div>
                <p id="noStudentText" class="text-[10px] text-gray-400 italic mt-2 text-center">Imbas kod pada kertas untuk detect</p>
            </div>

            <!-- Mode & Sifir Selection -->
            <div class="glass-card p-4 rounded-3xl lg:flex-grow lg:overflow-y-auto custom-scroll space-y-4">
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="setMode('learn')" id="btnLearn" class="py-2.5 rounded-xl font-black text-xs border-2 border-indigo-600 bg-indigo-600 text-white shadow">Belajar</button>
                    <button onclick="setMode('practice')" id="btnPractice" class="py-2.5 rounded-xl font-black text-xs border-2 border-indigo-100 text-indigo-600">Latihan</button>
                </div>

                <div class="grid grid-cols-3 gap-2">
                    <script>
                        for(let i=1; i<=9; i++) {
                            document.write(`<button onclick="selectSifir(${i})" id="sifir-${i}" class="sifir-btn h-10 rounded-lg font-black text-base border-2 border-gray-100 bg-white hover:border-indigo-300 transition-all">${i}</button>`);
                        }
                    </script>
                </div>

                <div id="scoreCard" class="hidden bg-white p-3 rounded-2xl border-2 border-emerald-100 border-b-4 border-b-emerald-500 animate-fade-up">
                    <div class="flex justify-between items-center mb-1">
                        <span class="font-black text-emerald-700 text-xs uppercase">Skor</span>
                        <span class="text-xl font-black text-emerald-600" id="currentScore">0/0</span>
                    </div>
                    <div class="flex justify-between items-center bg-emerald-50 p-2 rounded-xl">
                        <span class="text-[9px] font-black text-emerald-600">MASA</span>
                        <span class="text-lg font-mono font-black text-emerald-700" id="timerDisplay">00:00</span>
                    </div>
                </div>
                
                <button onclick="resetApp()" class="w-full py-2 text-gray-400 font-black text-[9px] uppercase tracking-widest border-2 border-transparent hover:text-gray-600 transition-colors">Reset Sesi</button>
            </div>
        </aside>

        <!-- Center: Interactive Visualization -->
        <article class="lg:col-span-5 flex flex-col gap-3 lg:overflow-hidden">
            <!-- MNL (Compact Scroll) -->
            <div class="glass-card p-3 rounded-2xl border-t-4 border-indigo-100 overflow-x-auto custom-scroll shrink-0">
                <div class="flex justify-between items-center gap-2 min-w-[380px]">
                    <script>
                        const mnlArr = ["+1", "+2", "+3", "+4", "¬±5", "-4", "-3", "-2", "-1"];
                        for(let i=1; i<=9; i++) {
                            document.write(`
                                <div id="mnl-${i}" class="w-9 h-9 rounded-full bg-white border-2 border-gray-100 flex flex-col items-center justify-center transition-all shrink-0">
                                    <span class="text-[10px] font-black">${i}</span>
                                    <span class="text-[7px] font-black text-indigo-500">${mnlArr[i-1]}</span>
                                </div>
                            `);
                        }
                    </script>
                </div>
            </div>

            <!-- Wheel Container -->
            <div class="flex-grow flex items-center justify-center p-2 min-h-[300px]">
                <div id="wheelWrapper" class="relative w-full aspect-square max-w-[380px] bg-white rounded-full shadow-inner border-4 border-dashed border-indigo-50 flex items-center justify-center mx-auto">
                    <span class="text-gray-300 font-black text-center p-10 text-lg uppercase tracking-widest leading-tight">Pilih Sifir</span>
                </div>
            </div>
        </article>

        <!-- Right: Scaffolding Guide -->
        <aside class="lg:col-span-4 flex flex-col lg:overflow-hidden">
            <div id="guidePanel" class="glass-card p-5 rounded-[2rem] flex flex-col border-l-[10px] border-indigo-500 shadow-xl h-full lg:overflow-hidden">
                <div id="guideContent" class="flex-grow lg:overflow-y-auto custom-scroll pr-1">
                    <div class="text-center py-10">
                        <h2 class="text-xl font-black text-indigo-700 mb-2">Panduan PdP</h2>
                        <p class="text-sm text-gray-400 font-bold leading-relaxed">Klik segmen pada roda untuk melihat langkah pengiraan visual.</p>
                    </div>
                </div>
                <div id="guideActions" class="mt-4 flex flex-col gap-2 shrink-0"></div>
            </div>
        </aside>
    </main>

    <!-- Modals -->
    <div id="lcdModal" class="fixed inset-0 bg-indigo-950 hidden z-[100] flex flex-col items-center justify-center p-6 text-center">
        <div class="lcd-timer text-white font-mono" id="lcdTimerDisplay">10:00</div>
        <div class="mt-8 flex gap-3">
            <button onclick="startLcdCountdown()" id="lcdStartBtn" class="px-8 py-4 bg-emerald-500 text-white rounded-2xl font-black text-xl shadow-xl">MULA</button>
            <button onclick="resetLcdCountdown()" class="px-8 py-4 bg-indigo-800 text-indigo-100 rounded-2xl font-black text-xl">RESET</button>
        </div>
        <p id="lcdStudentName" class="mt-10 text-indigo-300 text-2xl font-black uppercase tracking-widest truncate max-w-full px-4">SEMUA MURID</p>
        <button onclick="closeLCDMode()" class="absolute top-4 right-4 text-indigo-500 text-4xl font-black">√ó</button>
    </div>

    <div id="studentModal" class="fixed inset-0 bg-black/90 backdrop-blur-xl hidden z-50 flex flex-col items-center justify-center p-4">
        <div class="glass-card w-full max-w-4xl p-6 md:p-10 rounded-[2.5rem] max-h-[90vh] flex flex-col overflow-hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black text-indigo-700">Database Murid</h2>
                <button onclick="closeStudentManager()" class="text-gray-400 text-3xl font-black">√ó</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 overflow-hidden flex-grow">
                <div class="space-y-4 overflow-y-auto custom-scroll pr-2">
                    <div class="p-4 bg-gray-50 rounded-2xl border-2 border-white space-y-3 shadow-inner">
                        <h3 class="font-black text-indigo-600 text-[10px] uppercase tracking-widest">Tambah Murid</h3>
                        <input type="text" id="addName" placeholder="Nama Penuh" class="w-full px-4 py-2.5 rounded-xl border-2 border-gray-200 outline-none font-bold text-sm">
                        <input type="text" id="addClass" placeholder="Kelas (Contoh: 4 Intan)" class="w-full px-4 py-2.5 rounded-xl border-2 border-gray-200 outline-none font-bold text-sm">
                        <button onclick="addStudent()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-black shadow-lg">Simpan</button>
                    </div>
                    <div id="studentListContainer" class="space-y-2"></div>
                </div>
                <div class="bg-white border-4 border-indigo-50 rounded-3xl p-4 flex flex-col overflow-hidden">
                    <h3 class="font-black text-emerald-600 text-[10px] uppercase tracking-widest mb-4">Buku Rekod</h3>
                    <div id="gradebookList" class="flex-grow overflow-y-auto custom-scroll space-y-2"></div>
                    <button onclick="clearAllData()" class="mt-4 text-[9px] text-red-300 font-bold uppercase underline">Padam Data</button>
                </div>
            </div>
            <button onclick="generateTestForAll()" class="w-full mt-6 py-4 bg-emerald-600 text-white rounded-2xl font-black text-lg shadow-xl">Cetak Sifir 2-9 (QR)</button>
        </div>
    </div>

    <div id="scannerModal" class="fixed inset-0 bg-black/95 backdrop-blur-md hidden z-50 flex flex-col items-center justify-center p-6">
        <h2 class="text-2xl font-black text-white mb-6 uppercase">Detect Kertas Murid</h2>
        <div id="reader" class="w-full max-w-sm border-4 border-indigo-500 shadow-2xl"></div>
        <button onclick="toggleScanner()" class="mt-8 py-4 px-10 bg-white/10 text-white rounded-2xl font-black">Tutup</button>
    </div>

    <div id="entryModal" class="fixed inset-0 bg-black/70 hidden z-[60] flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-md p-6 rounded-[2.5rem] animate-fade-up border-t-[12px] border-indigo-600 text-center">
            <h2 class="text-xl font-black text-indigo-700 mb-2">Rekod Hasil Kertas</h2>
            <p id="entryStudentInfo" class="text-sm text-gray-500 font-bold mb-6"></p>
            <div class="space-y-5">
                <div class="grid grid-cols-5 gap-1.5" id="entrySifirGrid"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-black text-gray-400 uppercase mb-2">Betul (/10)</label>
                        <input type="number" id="entryScore" min="0" max="10" class="w-full px-3 py-3 rounded-xl border-2 border-gray-100 font-black text-2xl text-center outline-none">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-gray-400 uppercase mb-2">Masa (s)</label>
                        <input type="number" id="entryTime" placeholder="45" class="w-full px-3 py-3 rounded-xl border-2 border-gray-100 font-black text-2xl text-center outline-none">
                    </div>
                </div>
                <button onclick="saveEntry()" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg">Simpan Rekod</button>
                <button onclick="closeEntryModal()" class="w-full py-2 text-gray-400 font-bold uppercase text-[9px]">Batal</button>
            </div>
        </div>
    </div>

    <div id="printArea" class="hidden bg-white"></div>

    <script>
        // --- State Management ---
        let currentSifir = null, currentMode = 'learn', lang = 'ms';
        let score = { correct: 0, total: 0 }, activeMultiplier = null, currentSubStep = 0;
        let timerInterval = null, timeElapsed = 0, html5QrCode = null;
        let students = JSON.parse(localStorage.getItem('krd_students_v3') || '[]');
        let records = JSON.parse(localStorage.getItem('krd_records_v3') || '[]');
        let activeStudent = null, scanTargetSifir = 1;
        let lcdCountdownInterval = null, lcdTimeLeft = 600;

        const krdActions = {
            1: { val: 1, type: 'plus', display: '+1' }, 2: { val: 2, type: 'plus', display: '+2' },
            3: { val: 3, type: 'plus', display: '+3' }, 4: { val: 4, type: 'plus', display: '+4' },
            5: { val: 5, type: 'both', display: '¬±5' }, 6: { val: 4, type: 'minus', display: '-4' },
            7: { val: 3, type: 'minus', display: '-3' }, 8: { val: 2, type: 'minus', display: '-2' },
            9: { val: 1, type: 'minus', display: '-1' }
        };

        // --- Database & Student Logic ---
        function updateClassDropdown() {
            const drop = document.getElementById('classDropdown');
            const unique = [...new Set(students.map(s => s.kls))];
            drop.innerHTML = '<option value="">Pilih Kelas...</option>' + 
                unique.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function loadStudentsByClass() {
            const kls = document.getElementById('classDropdown').value;
            const drop = document.getElementById('studentDropdown');
            if(!kls) { drop.innerHTML = '<option value="">Pilih Murid...</option>'; return; }
            const classStudents = students.filter(s => s.kls === kls);
            drop.innerHTML = '<option value="">Pilih Murid...</option>' + 
                classStudents.map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        }

        function selectStudentFromList() {
            const name = document.getElementById('studentDropdown').value;
            const kls = document.getElementById('classDropdown').value;
            if(!name) { activeStudent = null; updateStudentUI(); return; }
            activeStudent = students.find(s => s.name === name && s.kls === kls);
            updateStudentUI();
        }

        function updateStudentUI() {
            const detail = document.getElementById('studentDetail');
            const placeholder = document.getElementById('noStudentText');
            const infoBox = document.getElementById('activeStudentInfo');
            if(!detail || !placeholder || !infoBox) return;

            if(activeStudent) {
                detail.classList.remove('hidden'); placeholder.classList.add('hidden'); infoBox.classList.remove('hidden');
                document.getElementById('dispName').innerText = activeStudent.name;
                document.getElementById('dispClass').innerText = activeStudent.kls;
            } else {
                detail.classList.add('hidden'); placeholder.classList.remove('hidden'); infoBox.classList.add('hidden');
            }
        }

        function addStudent() {
            const n = document.getElementById('addName').value, k = document.getElementById('addClass').value;
            if(!n || !k) return;
            students.push({ name: n, kls: k });
            localStorage.setItem('krd_students_v3', JSON.stringify(students));
            document.getElementById('addName').value = ''; document.getElementById('addClass').value = '';
            updateClassDropdown(); renderStudentList();
        }

        function renderStudentList() {
            const list = document.getElementById('studentListContainer');
            list.innerHTML = students.length ? '' : '<p class="text-center text-gray-300 py-6 text-[10px] uppercase">Data Kosong</p>';
            students.forEach((s, idx) => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center p-3 bg-white rounded-xl border border-gray-100 shadow-sm";
                div.innerHTML = `<div class="text-left leading-tight"><p class="font-black text-indigo-900 text-sm">${s.name}</p><p class="text-[9px] font-bold text-gray-400 uppercase">${s.kls}</p></div><button onclick="removeStudent(${idx})" class="text-red-300 font-black text-2xl">√ó</button>`;
                list.appendChild(div);
            });
        }

        function removeStudent(idx) {
            students.splice(idx, 1);
            localStorage.setItem('krd_students_v3', JSON.stringify(students));
            updateClassDropdown(); renderStudentList();
        }

        function renderGradebook() {
            const list = document.getElementById('gradebookList');
            list.innerHTML = records.length ? '' : '<p class="text-center text-gray-300 py-6 text-[10px] uppercase">Tiada Rekod</p>';
            [...records].reverse().forEach((r) => {
                const div = document.createElement('div');
                div.className = "p-3 bg-indigo-50 border border-indigo-100 rounded-xl flex justify-between items-center";
                div.innerHTML = `<div class="text-left leading-tight"><p class="font-black text-indigo-900 text-xs">${r.name}</p><p class="text-[9px] font-bold text-indigo-400">Sifir ${r.sifir} | Skor: ${r.score}/10 | ${r.time}s</p></div><span class="text-[8px] font-black text-indigo-300">${r.date}</span>`;
                list.appendChild(div);
            });
        }

        function clearAllData() { if(confirm("Padam semua?")) { students=[]; records=[]; localStorage.clear(); updateClassDropdown(); renderStudentList(); renderGradebook(); }}

        // --- Wheel & Logic ---
        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btnLearn').className = mode === 'learn' ? 'py-2.5 rounded-xl font-black text-xs border-2 border-indigo-600 bg-indigo-600 text-white shadow' : 'py-2.5 rounded-xl font-black text-xs border-2 border-indigo-100 text-indigo-600';
            document.getElementById('btnPractice').className = mode === 'practice' ? 'py-2.5 rounded-xl font-black text-xs border-2 border-emerald-600 bg-emerald-600 text-white shadow' : 'py-2.5 rounded-xl font-black text-xs border-2 border-indigo-100 text-indigo-600';
            document.getElementById('scoreCard').classList.toggle('hidden', mode === 'learn');
            resetApp();
        }

        function selectSifir(num) {
            currentSifir = num; resetTimer();
            document.querySelectorAll('.sifir-btn').forEach(b => b.classList.remove('border-indigo-600', 'bg-indigo-50', 'text-indigo-600'));
            const btn = document.getElementById(`sifir-${num}`); if(btn) btn.classList.add('border-indigo-600', 'bg-indigo-50', 'text-indigo-600');
            document.querySelectorAll('[id^="mnl-"]').forEach(m => m.classList.remove('mnl-active'));
            const mnl = document.getElementById(`mnl-${num}`); if(mnl) mnl.classList.add('mnl-active');
            renderWheel(num);
            document.getElementById('guideContent').innerHTML = `<div class="text-center mt-10"><h2 class="text-3xl font-black text-indigo-700">SIFIR ${num}</h2><p class="text-xs font-bold text-gray-400 uppercase tracking-widest">Sedia untuk Bermula</p></div>`;
        }

        function renderWheel(num) {
            const wrapper = document.getElementById('wheelWrapper'); wrapper.innerHTML = '';
            const center = 200, svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg"); svg.setAttribute("viewBox", `0 0 400 400`); svg.classList.add("w-full", "h-full");
            for (let i = 0; i < 10; i++) {
                const angle = 36, startA = i*angle-90, endA = (i+1)*angle-90, pathData = createArcPath(center, center, 85, 175, startA, endA);
                const g = document.createElementNS(svgNS, "g"); g.classList.add("cursor-pointer"); g.onclick = () => handleSegmentClick(i+1);
                const sector = document.createElementNS(svgNS, "path"); sector.setAttribute("d", pathData); sector.setAttribute("fill", "white"); sector.setAttribute("stroke", "#e5e7eb"); sector.setAttribute("stroke-width", "2");
                sector.id = `sector-${i+1}`; sector.classList.add("transition-all", "hover:fill-indigo-50");
                const rad = ((startA + 18) * Math.PI) / 180;
                const tx = center + Math.cos(rad) * 65, ty = center + Math.sin(rad) * 65;
                const label = document.createElementNS(svgNS, "text"); label.setAttribute("x", tx); label.setAttribute("y", ty); label.setAttribute("text-anchor", "middle"); label.setAttribute("alignment-baseline", "middle");
                label.classList.add("wheel-label", "text-[16px]", "fill-indigo-900"); label.textContent = i+1;
                const px = center + Math.cos(rad) * 135, py = center + Math.sin(rad) * 135;
                const ans = document.createElementNS(svgNS, "text"); ans.setAttribute("x", px); ans.setAttribute("y", py+5); ans.setAttribute("text-anchor", "middle");
                ans.classList.add("ans-label", "text-[18px]", "fill-gray-300"); ans.id = `ans-${i+1}`; ans.textContent = "??";
                g.appendChild(sector); g.appendChild(label); g.appendChild(ans); svg.appendChild(g);
            }
            const c = document.createElementNS(svgNS, "circle"); c.setAttribute("cx", center); c.setAttribute("cy", center); c.setAttribute("r", 40); c.setAttribute("fill", "#4f46e5");
            const ct = document.createElementNS(svgNS, "text"); ct.setAttribute("x", center); ct.setAttribute("y", center+6); ct.setAttribute("text-anchor", "middle"); ct.classList.add("fill-white", "font-black", "text-[22px]");
            ct.textContent = `${num}√ó`; svg.appendChild(c); svg.appendChild(ct); wrapper.appendChild(svg);
        }

        // --- LCD & Scanner Functions ---
        function openLCDMode() { document.getElementById('lcdModal').classList.remove('hidden'); document.getElementById('lcdStudentName').innerText = activeStudent ? activeStudent.name.toUpperCase() : "SEMUA MURID"; resetLcdCountdown(); }
        function closeLCDMode() { document.getElementById('lcdModal').classList.add('hidden'); resetLcdCountdown(); }
        function startLcdCountdown() {
            if(lcdCountdownInterval) { clearInterval(lcdCountdownInterval); lcdCountdownInterval = null; document.getElementById('lcdStartBtn').innerText = "TERUSKAN"; return; }
            const select = document.getElementById('lcdTimeSelect'); if(lcdTimeLeft <= 0) lcdTimeLeft = parseInt(select.value);
            document.getElementById('lcdStartBtn').innerText = "BERHENTI";
            lcdCountdownInterval = setInterval(() => { lcdTimeLeft--; updateLcdDisplay(); if(lcdTimeLeft <= 0) { clearInterval(lcdCountdownInterval); lcdCountdownInterval = null; alert("MASA TAMAT!"); resetLcdCountdown(); } }, 1000);
        }
        function resetLcdCountdown() { clearInterval(lcdCountdownInterval); lcdCountdownInterval = null; const select = document.getElementById('lcdTimeSelect'); lcdTimeLeft = parseInt(select.value); updateLcdDisplay(); document.getElementById('lcdStartBtn').innerText = "MULA"; }
        function updateLcdDisplay() { const m = Math.floor(lcdTimeLeft/60).toString().padStart(2, '0'), s = (lcdTimeLeft%60).toString().padStart(2, '0'); document.getElementById('lcdTimerDisplay').innerText = `${m}:${s}`; }

        function toggleScanner() {
            const modal = document.getElementById('scannerModal');
            if (!modal.classList.contains('hidden')) { if (html5QrCode) html5QrCode.stop().then(() => html5QrCode = null); modal.classList.add('hidden'); }
            else {
                modal.classList.remove('hidden'); html5QrCode = new Html5Qrcode("reader");
                html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 250 }, (text) => {
                    if(text.startsWith("LOGIN:")) {
                        const parts = text.replace("LOGIN:", "").split("|");
                        activeStudent = students.find(s => s.name === parts[0] && s.kls === parts[1]) || { name: parts[0], kls: parts[1] };
                        toggleScanner(); openEntryModal();
                    }
                }).catch(() => { alert("Akses kamera gagal."); toggleScanner(); });
            }
        }

        function openEntryModal() {
            if(!activeStudent) return; document.getElementById('entryModal').classList.remove('hidden');
            document.getElementById('entryStudentInfo').innerText = `${activeStudent.name} (${activeStudent.kls})`;
            const g = document.getElementById('entrySifirGrid'); g.innerHTML = "";
            for(let i=1; i<=9; i++) {
                const b = document.createElement('button'); b.className = `p-3 rounded-xl font-black text-sm border-2 ${scanTargetSifir==i?'bg-indigo-600 text-white border-indigo-600 shadow':'bg-white text-gray-500 border-gray-100'}`;
                b.innerText = i; b.onclick = () => { scanTargetSifir = i; openEntryModal(); }; g.appendChild(b);
            }
        }

        function closeEntryModal() { document.getElementById('entryModal').classList.add('hidden'); }
        function saveEntry() {
            const s = document.getElementById('entryScore').value, t = document.getElementById('entryTime').value; if(!s || !t) return;
            records.push({ name: activeStudent.name, kls: activeStudent.kls, sifir: scanTargetSifir, score: s, time: t, date: new Date().toLocaleDateString('ms-MY', {day:'2-digit', month:'short'}) });
            localStorage.setItem('krd_records_v3', JSON.stringify(records));
            updateStudentUI(); renderGradebook(); closeEntryModal();
        }

        // --- Interactive Flow ---
        function handleSegmentClick(m) {
            if(currentMode === 'practice' && !timerInterval && score.total === 0) startTimer();
            activeMultiplier = m; document.querySelectorAll('path').forEach(p => p.classList.remove('sector-highlight'));
            const s = document.getElementById(`sector-${m}`); if(s) s.classList.add('sector-highlight');
            if(currentMode === 'learn') { currentSubStep = 1; updateLearnUI(); } else { startPracticeUI(); }
        }

        function updateLearnUI() {
            const m = activeMultiplier, res = currentSifir * m, prevSa = (currentSifir * (m-1)) % 10, currSa = res % 10, action = krdActions[currentSifir];
            let content = `<h2 class="text-3xl font-black text-indigo-700 mb-4 text-center">${currentSifir} √ó ${m}</h2>`;
            if(currentSubStep >= 1) content += `<div class="step-box"><p class="text-[10px] font-black text-amber-600 uppercase mb-2 text-center underline">Langkah 1: Cari Sa</p><div class="flex items-center justify-center gap-4"><span class="text-xl font-black">${prevSa}</span><span class="text-xl font-black text-indigo-600">${action.display}</span><span class="text-3xl font-black text-amber-700">‚ûî ${currSa}</span></div></div>`;
            if(currentSubStep >= 2) content += `<div class="step-box"><p class="text-[10px] font-black text-indigo-600 uppercase mb-2 text-center underline">Langkah 2: Cari Puluh</p><p class="text-lg font-black text-indigo-800 text-center">${(prevSa > currSa && m > 1) ? "Menurun: Puluh +1" : "Naik/Sama: Puluh Kekal"}</p></div>`;
            if(currentSubStep === 3) {
                const ans = document.getElementById(`ans-${m}`); ans.textContent = res < 10 ? `0${res}` : res; ans.classList.replace('fill-gray-300', 'fill-indigo-600');
                content += `<div class="mt-4 p-6 bg-indigo-600 text-white rounded-3xl text-center shadow-xl animate-fade-up"><p class="text-[10px] uppercase opacity-70 mb-1">HASIL</p><p class="text-5xl font-black">${res}</p></div>`;
                document.getElementById('guideActions').innerHTML = `<button onclick="selectSifir(${currentSifir})" class="w-full py-4 bg-gray-100 rounded-2xl font-black text-gray-500">Seterusnya!</button>`;
            } else { document.getElementById('guideActions').innerHTML = `<button onclick="currentSubStep++; updateLearnUI();" class="w-full py-4 bg-indigo-600 text-white rounded-2xl font-black shadow-lg">Langkah Seterusnya</button>`; }
            document.getElementById('guideContent').innerHTML = content;
        }

        function startPracticeUI() {
            const currSa = (currentSifir * activeMultiplier) % 10;
            document.getElementById('guideContent').innerHTML = `<h2 class="text-xl font-black text-emerald-700 mb-6 text-center uppercase tracking-widest">Berapakah nilai Sa?</h2><div class="grid grid-cols-5 gap-2">${[0,1,2,3,4,5,6,7,8,9].map(i => `<button onclick="checkSa(${i}, ${currSa})" class="h-14 bg-white border-2 border-emerald-100 rounded-xl font-black text-xl shadow-sm hover:bg-emerald-50 transition-all">${i}</button>`).join('')}</div>`;
            document.getElementById('guideActions').innerHTML = "";
        }

        function checkSa(val, correct) {
            if(val === correct) { const prevSa = (currentSifir * (activeMultiplier-1)) % 10, correctRule = (prevSa > correct && activeMultiplier > 1) ? 'A' : 'B'; score.correct++; updatePracticeRuleUI(correctRule); }
            else alert("Salah! Guna aksi MNL.");
            score.total++; document.getElementById('currentScore').innerText = `${score.correct}/${score.total}`;
        }

        function updatePracticeRuleUI(correct) {
            document.getElementById('guideContent').innerHTML = `<h2 class="text-xl font-black text-emerald-700 mb-6 text-center uppercase tracking-widest">Pilih Peraturan?</h2><div class="grid grid-cols-1 gap-3"><button onclick="checkRule('A', '${correct}')" class="py-4 bg-white border-2 border-emerald-100 rounded-2xl font-black text-base text-emerald-700 shadow-sm uppercase">A (Menurun: +1)</button><button onclick="checkRule('B', '${correct}')" class="py-4 bg-white border-2 border-emerald-100 rounded-2xl font-black text-base text-emerald-700 shadow-sm uppercase">B (Naik/Sama: Kekal)</button></div>`;
        }

        function checkRule(val, correct) {
            if(val === correct || activeMultiplier === 1) {
                const res = currentSifir * activeMultiplier;
                const ans = document.getElementById(`ans-${activeMultiplier}`); ans.textContent = res < 10 ? `0${res}` : res; ans.classList.replace('fill-gray-300', 'fill-emerald-600');
                document.getElementById('guideContent').innerHTML = `<div class="text-center py-10 animate-fade-up"><p class="text-7xl font-black text-emerald-600 leading-none">${res}</p><p class="mt-4 text-xl font-black text-emerald-500 uppercase tracking-tighter">BETUL!</p></div>`;
                document.getElementById('guideActions').innerHTML = `<button onclick="nextPractice()" class="w-full py-4 bg-emerald-500 text-white rounded-xl font-black shadow-lg">Teruskan</button>`;
                score.correct++;
            } else alert("Peraturan salah!");
            score.total++; document.getElementById('currentScore').innerText = `${score.correct}/${score.total}`;
        }

        function nextPractice() {
            let answered = 0; for(let i=1; i<=10; i++) { if(document.getElementById(`ans-${i}`).textContent !== "??") answered++; }
            if (answered === 10) finishPractice();
            else { document.getElementById('guideContent').innerHTML = `<div class="flex flex-col items-center justify-center h-full py-10"><p class="text-lg font-black text-gray-300 text-center uppercase tracking-widest leading-relaxed">Sila tekan segmen roda seterusnya...</p></div>`; document.getElementById('guideActions').innerHTML = ""; }
        }

        function finishPractice() {
            resetTimer(); const n = activeStudent ? activeStudent.name : "Murid", k = activeStudent ? activeStudent.kls : "Tiada", data = `STUDENT:${n}|CLASS:${k}|SCORE:${score.correct}/${score.total}`;
            const qr = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(data)}`;
            document.getElementById('guideContent').innerHTML = `<div class="text-center animate-fade-up"><h2 class="text-2xl font-black text-indigo-700 mb-4 uppercase">Sesi Tamat!</h2><div class="flex justify-center mb-4"><img src="${qr}" class="w-36 h-36 border-4 border-white shadow-xl rounded-2xl"></div><div class="text-left bg-indigo-50 p-4 rounded-2xl border-2 border-indigo-100"><p class="text-lg font-black text-indigo-800 leading-tight">${n}</p><p class="font-bold text-indigo-500 text-xs uppercase">${k}</p></div></div>`;
            document.getElementById('guideActions').innerHTML = `<button onclick="resetApp()" class="w-full py-4 bg-indigo-600 text-white rounded-xl font-black">Latihan Baru</button>`;
        }

        // --- Helpers ---
        function createArcPath(x, y, innerR, outerR, startA, endA) {
            const sR = startA * Math.PI / 180, eR = endA * Math.PI / 180;
            return `M ${x+Math.cos(sR)*outerR} ${y+Math.sin(sR)*outerR} A ${outerR} ${outerR} 0 0 1 ${x+Math.cos(eR)*outerR} ${y+Math.sin(eR)*outerR} L ${x+Math.cos(eR)*innerR} ${y+Math.sin(eR)*innerR} A ${innerR} ${innerR} 0 0 0 ${x+Math.cos(sR)*innerR} ${y+Math.sin(sR)*innerR} Z`;
        }
        function startTimer() { if (timerInterval) return; let sT = Date.now(); timerInterval = setInterval(() => { timeElapsed = Math.floor((Date.now()-sT)/1000); const m = Math.floor(timeElapsed/60).toString().padStart(2,'0'), s = (timeElapsed%60).toString().padStart(2,'0'); document.getElementById('timerDisplay').innerText = `${m}:${s}`; }, 1000); }
        function resetTimer() { clearInterval(timerInterval); timerInterval = null; timeElapsed = 0; if(document.getElementById('timerDisplay')) document.getElementById('timerDisplay').innerText = "00:00"; }
        function openStudentManager() { document.getElementById('studentModal').classList.remove('hidden'); renderStudentList(); renderGradebook(); }
        function closeStudentManager() { document.getElementById('studentModal').classList.add('hidden'); }
        function resetApp() { 
            currentSifir = null; score = { correct: 0, total: 0 }; document.getElementById('currentScore').innerText = "0/0"; resetTimer();
            document.getElementById('wheelWrapper').innerHTML = `<span class="text-gray-300 font-black text-center p-8 text-xl uppercase tracking-widest leading-tight">Pilih Sifir</span>`;
            document.getElementById('guideContent').innerHTML = `<div class="text-center py-10"><h2 class="text-xl font-black text-indigo-700 mb-2">Panduan PdP</h2><p class="text-sm text-gray-400 font-bold leading-relaxed">Klik segmen pada roda untuk melihat langkah pengiraan visual.</p></div>`;
            document.getElementById('guideActions').innerHTML = "";
        }

        function generateTestForAll() {
            if(!students.length) return alert("Daftar murid dahulu.");
            const p = document.getElementById('printArea'); p.innerHTML = "";
            students.forEach((s) => {
                const pg = document.createElement('div'); pg.className = "p-10 page-break";
                const qr = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent("LOGIN:"+s.name+"|"+s.kls)}`;
                let h = `<div class="flex justify-between items-start border-b-8 border-black pb-8 mb-10"><div><h1 class="text-6xl font-black tracking-tighter uppercase">Kit Roda Darab</h1><p class="text-4xl font-bold mt-6 uppercase">Nama: ${s.name}</p><p class="text-3xl font-bold uppercase">Kelas: ${s.kls}</p></div><div class="text-center"><img src="${qr}" class="w-36 h-36 border-4 border-black p-1 shadow-sm"><p class="text-[10px] font-black mt-3 uppercase tracking-widest">Scan QR</p></div></div><div class="grid grid-cols-3 gap-10">`;
                for(let sf=2; sf<=9; sf++) {
                    h += `<div class="border-4 border-black p-4 rounded-[3.5rem] flex flex-col items-center"><svg viewBox="0 0 320 320" class="w-full h-auto">${Array.from({length:10}, (_, i) => { const a = i*36-90, r = ((a + 18) * Math.PI) / 180; return `<path d="${createArcPath(160,160,80,140,a,a+36)}" fill="none" stroke="black" stroke-width="4" /><text x="${160+Math.cos(r)*65}" y="${160+Math.sin(r)*65}" text-anchor="middle" font-size="22" font-weight="900" alignment-baseline="middle">${i+1}</text><text x="${160+Math.cos(r)*112}" y="${160+Math.sin(r)*115}" text-anchor="middle" font-size="14" fill="#ddd">____</text>`; }).join('')}<circle cx="160" cy="160" r="30" fill="none" stroke="black" stroke-width="4" /><text x="160" y="168" text-anchor="middle" font-size="24" font-weight="900">${sf}√ó</text></svg><p class="mt-4 font-black text-2xl uppercase">Sifir ${sf}</p></div>`;
                }
                pg.innerHTML = h + `</div><div class="mt-16 flex justify-end gap-12 font-black text-2xl italic uppercase border-t-4 border-black pt-8"><span>Markah: _____ / 80</span><span>Masa: _________</span></div>`; p.appendChild(pg);
            }); window.print();
        }

        // --- Start ---
        updateClassDropdown(); renderStudentList(); renderGradebook(); resetApp();
    </script>
</body>
</html>
