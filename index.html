<!doctype html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Meta Tags -->
    <title>CirculoX</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CirculoX">
    <meta name="theme-color" content="#4f46e5">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <!-- Tambah QRCode.js untuk penjanaan QR offline yang stabil -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap');

        :root {
            --primary: #312e81; 
            --accent: #4f46e5;
            --bg-gradient: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: #111827;
            -webkit-tap-highlight-color: transparent;
        }

        @media (min-width: 1024px) {
            body { height: 100vh; overflow: hidden; }
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(12px);
            border: 2px solid rgba(79, 70, 229, 0.1);
            box-shadow: 0 10px 35px rgba(31, 38, 135, 0.1);
        }

        .mnl-active {
            background: var(--accent) !important;
            color: white !important;
            transform: scale(1.15);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
            z-index: 10;
        }

        /* Responsive MNL */
        .mnl-item { width: 2.25rem; height: 2.25rem; transition: all 0.3s ease; }
        @media (min-width: 1024px) {
            .mnl-item { width: 4.5rem; height: 4.5rem; border-width: 3px; }
            .mnl-item span:first-child { font-size: 1.5rem !important; }
            .mnl-item span:last-child { font-size: 0.875rem !important; }
        }

        .step-box {
            border-left: 8px solid var(--accent); background: #ffffff; padding: 1.25rem;
            border-radius: 1.25rem; margin-bottom: 1.25rem; box-shadow: 0 4px 15px rgba(0,0,0,0.06);
        }

        .wheel-label, .ans-label { pointer-events: none; font-weight: 700; }
        .sector-highlight { stroke: var(--accent); stroke-width: 6; fill: #f5f7ff !important; }

        /* LCD Timer */
        .lcd-timer {
            font-size: clamp(4rem, 15vw, 15rem); line-height: 1; font-weight: 900; color: #ffffff;
            text-shadow: 0 0 40px rgba(79, 70, 229, 0.8);
        }

        .custom-scroll::-webkit-scrollbar { width: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c7d2fe; border-radius: 10px; }

        @media print {
            body > *:not(#printArea) { display: none !important; }
            #printArea { display: block !important; position: absolute; left: 0; top: 0; width: 100%; background: white; z-index: 9999; }
            .page-break { page-break-after: always; display: block; min-height: 100vh; position: relative; padding: 20px; }
            /* Paksa cetakan background graphics */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }

        #reader { width: 100% !important; border-radius: 1.5rem; overflow: hidden; }
        .text-pdp-primary { color: #1e1b4b; } .text-pdp-accent { color: #4338ca; }

        /* Leaderboard Bar Animation */
        @keyframes growBar { from { width: 0; } to { width: var(--w); } }
        .bar-fill { animation: growBar 1.5s ease-out forwards; }
    </style>
</head>
<body class="flex flex-col">

    <!-- Header -->
    <header class="flex justify-between items-center p-3 md:p-5 no-print shrink-0 bg-white/50 border-b border-indigo-100">
        <div class="flex items-center gap-3">
            <h1 class="text-2xl md:text-3xl font-black text-pdp-primary tracking-tighter">CirculoX</h1>
            <div id="connStatus" class="hidden sm:flex px-3 py-1 bg-gray-200 text-gray-600 text-[10px] font-black rounded-full uppercase tracking-wider">OFFLINE</div>
        </div>
        <div class="flex gap-2">
            <button onclick="openLCDMode()" class="p-2.5 bg-indigo-950 text-white rounded-xl shadow-lg hover:scale-105 transition-all" title="Mod LCD">üñ•Ô∏è</button>
            <button onclick="openStudentManager()" class="p-2.5 bg-emerald-700 text-white rounded-xl shadow-lg hover:scale-105 transition-all" title="Murid">üë•</button>
            <button onclick="toggleScanner()" class="p-2.5 bg-amber-600 text-white rounded-xl shadow-lg hover:scale-105 transition-all" title="Imbas">üì∑</button>
            <button onclick="openSynergyModal()" class="p-2.5 bg-blue-600 text-white rounded-xl shadow-lg hover:scale-105 transition-all animate-pulse" title="Sinergi">üì°</button>
        </div>
    </header>

    <!-- Main Workspace -->
    <main class="flex-grow flex flex-col lg:grid lg:grid-cols-12 gap-4 p-3 md:p-5 lg:overflow-hidden no-print">
        
        <!-- Left: Controls -->
        <aside class="lg:col-span-3 flex flex-col gap-4 lg:overflow-hidden">
            <div class="glass-card p-5 rounded-[2rem] border-b-8 border-indigo-600">
                <div class="space-y-3">
                    <label class="text-[10px] font-black text-indigo-900 uppercase tracking-widest pl-1">Pilih Kumpulan</label>
                    <select id="classDropdown" onchange="loadStudentsByClass()" class="w-full bg-indigo-50 border-2 border-indigo-200 rounded-xl px-4 py-2.5 font-bold text-indigo-900 text-sm outline-none">
                        <option value="">Pilih Kelas...</option>
                    </select>
                    <select id="studentDropdown" onchange="selectStudentFromList()" class="w-full bg-white border-2 border-gray-200 rounded-xl px-4 py-2.5 font-bold text-gray-700 text-sm outline-none">
                        <option value="">Pilih Murid...</option>
                    </select>
                </div>
                <div id="activeStudentInfo" class="mt-4 pt-4 border-t border-indigo-50 hidden">
                    <p class="text-[10px] font-black text-indigo-400 uppercase tracking-widest">Murid Aktif</p>
                    <div id="studentDetail">
                        <p id="dispName" class="text-xl font-black text-pdp-primary truncate leading-tight"></p>
                        <p id="dispClass" class="text-sm font-bold text-indigo-500"></p>
                    </div>
                </div>
            </div>

            <div class="glass-card p-5 rounded-[2rem] lg:flex-grow lg:overflow-y-auto custom-scroll space-y-5">
                <div>
                    <h3 class="text-[10px] font-black text-gray-400 uppercase mb-3 tracking-widest">Mod Pembelajaran</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="setMode('learn')" id="btnLearn" class="py-3 rounded-xl font-black text-sm border-2 border-indigo-600 bg-indigo-600 text-white shadow-lg">Belajar</button>
                        <button onclick="setMode('practice')" id="btnPractice" class="py-3 rounded-xl font-black text-sm border-2 border-indigo-100 text-indigo-900 hover:bg-indigo-50">Latihan</button>
                    </div>
                </div>
                <div>
                    <h3 class="text-[10px] font-black text-gray-400 uppercase mb-3 tracking-widest">Sifir Utama</h3>
                    <div class="grid grid-cols-3 gap-2.5">
                        <script>
                            for(let i=1; i<=9; i++) document.write(`<button onclick="selectSifir(${i})" id="sifir-${i}" class="sifir-btn h-12 rounded-xl font-black text-xl border-2 border-gray-100 bg-white hover:border-indigo-400 text-indigo-900 shadow-sm transition-all">${i}</button>`);
                        </script>
                    </div>
                </div>
                <div id="scoreCard" class="hidden bg-white p-4 rounded-2xl border-2 border-emerald-100 border-b-8 border-b-emerald-600">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-black text-emerald-800 text-xs uppercase">Skor</span>
                        <span class="text-3xl font-black text-emerald-600" id="currentScore">0/0</span>
                    </div>
                    <div class="flex justify-between items-center bg-emerald-50 p-3 rounded-xl">
                        <span class="text-[10px] font-black text-emerald-700">MASA</span>
                        <span class="text-2xl font-mono font-black text-emerald-800" id="timerDisplay">00:00</span>
                    </div>
                </div>
                <button onclick="resetApp()" class="w-full py-2 text-gray-400 font-bold text-[10px] uppercase border-2 border-transparent hover:text-red-500">Padam Sesi</button>
            </div>
        </aside>

        <!-- Center: Visualization -->
        <article class="lg:col-span-5 flex flex-col gap-4 lg:overflow-hidden">
            <div class="glass-card p-4 rounded-[2rem] border-t-8 border-indigo-600 overflow-x-auto custom-scroll shrink-0">
                <h3 class="text-center font-black text-indigo-900 mb-4 text-[11px] uppercase tracking-widest">Garis Nombor Ajaib</h3>
                <div class="flex justify-between items-center gap-3 md:px-4 min-w-[380px] lg:min-w-0">
                    <script>
                        const mnlArr = ["+1", "+2", "+3", "+4", "¬±5", "-4", "-3", "-2", "-1"];
                        for(let i=1; i<=9; i++) {
                            document.write(`<div id="mnl-${i}" class="mnl-item rounded-full bg-white border-2 border-gray-200 flex flex-col items-center justify-center transition-all shrink-0 shadow-sm"><span class="text-xs font-black text-pdp-primary">${i}</span><span class="text-[8px] font-black text-indigo-600">${mnlArr[i-1]}</span></div>`);
                        }
                    </script>
                </div>
            </div>
            <div class="flex-grow flex items-center justify-center p-2 min-h-[350px]">
                <div id="wheelWrapper" class="relative w-full aspect-square max-w-[420px] bg-white rounded-full shadow-2xl border-8 border-dashed border-indigo-50 flex items-center justify-center mx-auto transition-transform">
                    <span class="text-gray-300 font-black text-center p-10 text-2xl uppercase tracking-tighter">Sila Pilih Sifir</span>
                </div>
            </div>
        </article>

        <!-- Right: Guide / Leaderboard -->
        <aside class="lg:col-span-4 flex flex-col lg:overflow-hidden">
            <div id="guidePanel" class="glass-card p-6 rounded-[2.5rem] flex flex-col border-l-[15px] border-indigo-800 shadow-xl h-full lg:overflow-hidden relative">
                <!-- LCD Leaderboard Overlay (Hidden by default) -->
                <div id="lcdLeaderboard" class="absolute inset-0 bg-white z-20 hidden flex flex-col p-6 overflow-hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-black text-indigo-900 uppercase tracking-tighter">üèÜ Top 5 Terpantas</h2>
                        <button onclick="closeLeaderboard()" class="text-gray-400 hover:text-red-500 text-2xl">√ó</button>
                    </div>
                    <div id="leaderboardContent" class="flex-grow overflow-y-auto space-y-4"></div>
                </div>

                <div id="guideContent" class="flex-grow lg:overflow-y-auto custom-scroll pr-2">
                    <div class="text-center py-12">
                        <div class="w-16 h-16 bg-indigo-50 rounded-full flex items-center justify-center mx-auto mb-6 text-indigo-600">üí°</div>
                        <h2 class="text-2xl font-black text-pdp-primary mb-3">Panduan PdP</h2>
                        <p class="text-sm text-gray-500 font-bold leading-relaxed px-4">Pilih murid dan sifir untuk bermula.</p>
                    </div>
                </div>
                <div id="guideActions" class="mt-5 flex flex-col gap-3 shrink-0"></div>
            </div>
        </aside>
    </main>

    <!-- Synergy Modal (PeerJS Connection) -->
    <div id="synergyModal" class="fixed inset-0 bg-black/90 backdrop-blur-md hidden z-[80] flex flex-col items-center justify-center p-6 text-center">
        <div class="glass-card w-full max-w-md p-8 rounded-[3rem] animate-fade-up border-t-[15px] border-blue-600 relative">
            <button onclick="closeSynergyModal()" class="absolute top-4 right-6 text-gray-400 hover:text-red-500 text-3xl font-black">√ó</button>
            <h2 class="text-2xl font-black text-indigo-900 mb-2">Sinergi CirculoX</h2>
            <p class="text-xs text-indigo-400 font-bold mb-6 uppercase tracking-widest">Fungsi ini memerlukan Internet</p>
            
            <div id="synergyHostView" class="hidden space-y-6">
                <div class="p-4 bg-white border-4 border-indigo-100 rounded-3xl inline-block">
                    <img id="synergyQr" class="w-48 h-48" alt="QR Sambungan">
                </div>
                <p class="text-sm font-bold text-gray-500 px-4">Imbas QR ini menggunakan Telefon Guru untuk menjadikan telefon sebagai alat kawalan jauh.</p>
                <div class="animate-pulse text-xs font-black text-blue-600 bg-blue-50 py-2 rounded-lg">Menunggu sambungan...</div>
            </div>

            <div id="synergyRemoteView" class="hidden space-y-6">
                <div class="p-4 bg-emerald-50 rounded-2xl border border-emerald-200">
                    <p class="text-emerald-700 font-black text-lg">Connected to LCD!</p>
                </div>
                <p class="text-sm font-bold text-gray-500">Anda kini boleh menghantar data rekod dari telefon ini ke skrin LCD.</p>
                <button onclick="sendLeaderboardToLCD()" class="w-full py-5 bg-indigo-700 text-white rounded-2xl font-black text-xl shadow-xl hover:bg-indigo-900 transition-all flex items-center justify-center gap-3">
                    üöÄ Hantar Carta Top 5
                </button>
            </div>

            <div id="synergyLoading" class="py-10">
                <p class="font-black text-indigo-300 animate-pulse">Sedang menjana ID...</p>
            </div>
        </div>
    </div>

    <!-- LCD / Countdown Mode -->
    <div id="lcdModal" class="fixed inset-0 bg-indigo-950 hidden z-[100] flex flex-col items-center justify-center p-6 text-center">
        <h2 class="text-white text-3xl font-black uppercase tracking-[0.3em] mb-10 opacity-80">Cabaran CirculoX</h2>
        <div class="lcd-timer font-mono" id="lcdTimerDisplay">10:00</div>
        
        <!-- Timer Controls -->
        <div class="flex items-center justify-center gap-4 mb-8">
            <select id="lcdTimeSelect" class="bg-indigo-900 text-white border-2 border-indigo-700 rounded-xl px-4 py-2 font-bold text-lg outline-none cursor-pointer">
                <option value="300">5 Minit</option>
                <option value="600" selected>10 Minit</option>
                <option value="900">15 Minit</option>
                <option value="custom">Custom...</option>
            </select>
            <input type="number" id="lcdCustomTime" placeholder="Minit" class="hidden w-24 bg-white text-indigo-900 border-2 border-indigo-700 rounded-xl px-4 py-2 font-bold text-lg outline-none" min="1">
        </div>

        <div class="flex gap-5">
            <button onclick="startLcdCountdown()" id="lcdStartBtn" class="px-12 py-5 bg-emerald-600 text-white rounded-2xl font-black text-2xl shadow-2xl hover:scale-105 transition-all">MULA</button>
            <button onclick="resetLcdCountdown()" class="px-12 py-5 bg-indigo-800 text-indigo-100 rounded-2xl font-black text-2xl">RESET</button>
        </div>
        <div class="mt-16 py-4 px-10 bg-indigo-900/50 rounded-full border border-indigo-700">
            <p id="lcdStudentName" class="text-indigo-200 text-3xl font-black uppercase tracking-widest truncate max-w-full">SEMUA MURID</p>
        </div>
        <button onclick="closeLCDMode()" class="absolute top-6 right-6 text-indigo-400 hover:text-white text-6xl font-black transition-colors">√ó</button>
    </div>

    <!-- Database & Scanner Modals -->
    <div id="studentModal" class="fixed inset-0 bg-black/90 backdrop-blur-xl hidden z-50 flex flex-col items-center justify-center p-4">
        <div class="glass-card w-full max-w-6xl p-6 md:p-8 rounded-[3rem] max-h-[95vh] flex flex-col overflow-hidden">
            <div class="flex justify-between items-center mb-4 px-2">
                <h2 class="text-3xl font-black text-pdp-primary">Pengurusan Data</h2>
                <button onclick="closeStudentManager()" class="text-gray-400 hover:text-red-600 text-4xl font-black">√ó</button>
            </div>
            <div class="flex gap-3 mb-6 px-2">
                <button onclick="exportDatabase()" class="flex-1 py-3 bg-blue-50 text-blue-700 border border-blue-200 rounded-xl font-black text-xs uppercase">Simpan Data</button>
                <button onclick="triggerImport()" class="flex-1 py-3 bg-amber-50 text-amber-700 border border-amber-200 rounded-xl font-black text-xs uppercase">Muat Naik Data</button>
                <input type="file" id="importFile" class="hidden" accept=".json" onchange="importDatabase(this)">
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 overflow-hidden flex-grow px-2">
                <div class="space-y-6 overflow-y-auto custom-scroll pr-2">
                    <div class="p-6 bg-indigo-50 rounded-3xl border-2 border-indigo-100 space-y-4 shadow-sm">
                        <h3 class="font-black text-indigo-900 text-xs uppercase tracking-widest">Input Pukal</h3>
                        <textarea id="bulkInput" placeholder="Nama, Kelas" class="w-full h-32 px-5 py-4 rounded-2xl border-2 border-white outline-none font-bold text-sm resize-none"></textarea>
                        <button onclick="addBulkStudents()" class="w-full py-3.5 bg-indigo-700 text-white rounded-xl font-black text-sm">Simpan Pukal</button>
                    </div>
                    <div id="studentListContainer" class="space-y-2"></div>
                </div>
                <div class="bg-white border-4 border-indigo-50 rounded-[2.5rem] p-6 flex flex-col overflow-hidden">
                    <h3 class="font-black text-emerald-700 text-xs uppercase tracking-widest mb-2 text-center">Rekod & Cetak</h3>
                    <div class="bg-emerald-50 p-4 rounded-2xl mb-4 border border-emerald-100 flex gap-3">
                        <select id="printClassSelect" class="flex-1 px-4 py-3 rounded-xl border-2 border-emerald-200 font-bold text-emerald-900 outline-none text-sm bg-white"><option value="all">SEMUA KELAS</option></select>
                        <button onclick="generateTestByClass()" class="px-6 py-3 bg-emerald-600 text-white rounded-xl font-black">CETAK PDF</button>
                    </div>
                    <div id="gradebookList" class="flex-grow overflow-y-auto custom-scroll space-y-3 pr-1"></div>
                    <button onclick="clearAllData()" class="mt-4 text-[10px] text-red-400 font-bold uppercase underline text-center">Padam Semua</button>
                </div>
            </div>
        </div>
    </div>

    <div id="scannerModal" class="fixed inset-0 bg-black/95 backdrop-blur-md hidden z-50 flex flex-col items-center justify-center p-6 text-center">
        <h2 class="text-3xl font-black text-white mb-8 uppercase tracking-widest">Imbas Kod Kertas</h2>
        <div id="reader" class="rounded-[2rem] overflow-hidden w-full max-w-sm border-4 border-indigo-600 bg-white"></div>
        <button onclick="toggleScanner()" class="mt-10 py-4 px-14 bg-white/10 text-white border border-white/20 rounded-2xl font-black text-lg">Tutup</button>
    </div>

    <div id="entryModal" class="fixed inset-0 bg-black/70 hidden z-[60] flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-md p-8 rounded-[3rem] animate-fade-up border-indigo-700 border-t-[15px] text-center shadow-2xl">
            <h2 class="text-2xl font-black text-indigo-900 mb-2">Rekod Markah</h2>
            <p id="entryStudentInfo" class="text-indigo-500 font-bold mb-8 text-sm uppercase tracking-wider"></p>
            <div class="space-y-8">
                <div><label class="block text-[10px] font-black text-gray-400 uppercase mb-4 text-left pl-1">Sifir</label><div class="grid grid-cols-5 gap-2" id="entrySifirGrid"></div></div>
                <div class="grid grid-cols-2 gap-6">
                    <div><label class="block text-[10px] font-black text-gray-400 uppercase mb-3 text-left pl-1">Betul</label><input type="number" id="entryScore" min="0" max="10" class="w-full px-5 py-4 rounded-2xl border-2 border-indigo-50 bg-indigo-50 font-black text-4xl text-center outline-none"></div>
                    <div><label class="block text-[10px] font-black text-gray-400 uppercase mb-3 text-left pl-1">Masa</label><input type="number" id="entryTime" placeholder="45" class="w-full px-5 py-4 rounded-2xl border-2 border-indigo-50 bg-indigo-50 font-black text-4xl text-center outline-none"></div>
                </div>
                <button onclick="saveEntry()" class="w-full py-5 bg-indigo-700 text-white rounded-2xl font-black text-xl">Simpan</button>
                <button onclick="closeEntryModal()" class="w-full py-2 text-gray-400 font-bold uppercase text-[10px]">Batal</button>
            </div>
        </div>
    </div>

    <div id="printArea" class="hidden bg-white"></div>

    <script>
        // --- Setup PWA & PeerJS ---
        const manifest = {name:"CirculoX",short_name:"CirculoX",start_url:".",display:"standalone",background_color:"#e0e7ff",theme_color:"#4f46e5",icons:[{src:"data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIj48cmVjdCB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgZmlsbD0iIzRmNDZlNSIvPjxjaXJjbGUgY3g9IjI1NiIgY3k9IjI1NiIgcj0iMTYwIiBmaWxsPSJ3aGl0ZSIvPjxwYXRoIGQ9Ik0yNTYgMTYwdjE5Mm0tOTYtOTZoMTkyIiBzdHJva2U9IiM0ZjQ2ZTUiIHN0cm9rZS13aWR0aD0iNDAiLz48L3N2Zz4=",sizes:"192x192",type:"image/png"}]};
        const manifestLink = document.createElement('link'); manifestLink.rel = 'manifest'; manifestLink.href = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type:'application/json'})); document.head.appendChild(manifestLink);

        let peer = null;
        let conn = null;
        let myPeerId = null;

        // Check URL for Remote Mode
        const urlParams = new URLSearchParams(window.location.search);
        const remoteTargetId = urlParams.get('remote');

        if(remoteTargetId) {
            setTimeout(() => startRemoteMode(remoteTargetId), 1000);
        }

        function openSynergyModal() {
            document.getElementById('synergyModal').classList.remove('hidden');
            if(!peer) initPeer();
        }

        function closeSynergyModal() {
            document.getElementById('synergyModal').classList.add('hidden');
        }

        function initPeer() {
            document.getElementById('synergyLoading').classList.remove('hidden');
            peer = new Peer();
            
            peer.on('open', (id) => {
                myPeerId = id;
                document.getElementById('synergyLoading').classList.add('hidden');
                
                if (remoteTargetId) {
                    // Do nothing
                } else {
                    document.getElementById('synergyHostView').classList.remove('hidden');
                    const connUrl = window.location.href.split('?')[0] + '?remote=' + id;
                    // QR for PeerJS connection
                    const qrEl = document.getElementById('synergyQr');
                    // Use QR Code API for Synergy as it needs internet anyway
                    qrEl.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(connUrl)}`;
                    
                    peer.on('connection', (c) => {
                        conn = c;
                        setupConnection();
                        alert("Telefon disambungkan!");
                        closeSynergyModal();
                        document.getElementById('connStatus').innerText = "SINERGI AKTIF";
                        document.getElementById('connStatus').classList.replace('bg-gray-200','bg-green-200');
                        document.getElementById('connStatus').classList.replace('text-gray-600','text-green-700');
                    });
                }
            });
        }

        function startRemoteMode(targetId) {
            openSynergyModal();
            document.getElementById('synergyHostView').classList.add('hidden');
            document.getElementById('synergyRemoteView').classList.remove('hidden');
            
            if(!peer) peer = new Peer();
            
            peer.on('open', () => {
                conn = peer.connect(targetId);
                setupConnection();
            });
        }

        function setupConnection() {
            conn.on('data', (data) => {
                if(data.type === 'LEADERBOARD') {
                    showLeaderboardOnLCD(data.payload);
                }
            });
        }

        function sendLeaderboardToLCD() {
            if(!conn) return alert("Tiada sambungan ke LCD.");
            
            const sortedRecords = [...records]
                .sort((a,b) => {
                    if (b.score !== a.score) return b.score - a.score;
                    return a.time - b.time;
                })
                .slice(0, 5);

            conn.send({
                type: 'LEADERBOARD',
                payload: sortedRecords
            });
            alert("Data dihantar ke LCD!");
        }

        function showLeaderboardOnLCD(data) {
            const container = document.getElementById('lcdLeaderboard');
            const content = document.getElementById('leaderboardContent');
            container.classList.remove('hidden');
            content.innerHTML = "";

            if(data.length === 0) {
                content.innerHTML = "<p class='text-center text-gray-400 font-bold'>Tiada Rekod</p>";
                return;
            }

            data.forEach((r, idx) => {
                const colors = ["bg-yellow-400", "bg-gray-300", "bg-amber-600", "bg-indigo-100", "bg-indigo-50"];
                const width = Math.max(20, (r.score / 10) * 100);
                
                const item = document.createElement('div');
                item.className = "flex items-center gap-4 animate-fade-up";
                item.style.animationDelay = `${idx * 0.1}s`;
                item.innerHTML = `
                    <div class="w-12 h-12 flex items-center justify-center font-black text-xl rounded-full ${colors[idx] || "bg-gray-100"} text-white shadow-md border-2 border-white shrink-0">
                        ${idx + 1}
                    </div>
                    <div class="flex-grow">
                        <div class="flex justify-between text-indigo-900 font-black text-lg mb-1">
                            <span>${r.name}</span>
                            <span>${r.time}s</span>
                        </div>
                        <div class="h-6 w-full bg-gray-100 rounded-full overflow-hidden">
                            <div class="h-full bg-gradient-to-r from-indigo-500 to-purple-500 bar-fill" style="--w: ${width}%"></div>
                        </div>
                        <p class="text-xs text-indigo-400 font-bold mt-1 uppercase tracking-wider">${r.kls} ‚Ä¢ Sifir ${r.sifir} ‚Ä¢ Skor ${r.score}</p>
                    </div>
                `;
                content.appendChild(item);
            });
        }

        function closeLeaderboard() {
            document.getElementById('lcdLeaderboard').classList.add('hidden');
        }

        // --- Init State ---
        let currentSifir = null, currentMode = 'learn', lang = 'ms';
        let score = { correct: 0, total: 0 }, activeMultiplier = null, currentSubStep = 0;
        let timerInterval = null, timeElapsed = 0, html5QrCode = null;
        let students = JSON.parse(localStorage.getItem('krd_students_v3') || '[]');
        let records = JSON.parse(localStorage.getItem('krd_records_v3') || '[]');
        let activeStudent = null, scanTargetSifir = 1;
        let lcdCountdownInterval = null, lcdTimeLeft = 600;

        const krdActions = {
            1: { val: 1, type: 'plus', display: '+1' }, 2: { val: 2, type: 'plus', display: '+2' },
            3: { val: 3, type: 'plus', display: '+3' }, 4: { val: 4, type: 'plus', display: '+4' },
            5: { val: 5, type: 'both', display: '¬±5' }, 6: { val: 4, type: 'minus', display: '-4' },
            7: { val: 3, type: 'minus', display: '-3' }, 8: { val: 2, type: 'minus', display: '-2' },
            9: { val: 1, type: 'minus', display: '-1' }
        };

        // --- Database & Import/Export ---
        function exportDatabase() {
            const data = { students, records, timestamp: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
            a.download = "circulox_backup_" + new Date().toISOString().slice(0,10) + ".json";
            document.body.appendChild(a); a.click(); a.remove();
        }
        function triggerImport() { document.getElementById('importFile').click(); }
        function importDatabase(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.students) {
                        if (confirm("Gantikan data semasa dengan backup?")) {
                            students = data.students; records = data.records || [];
                            localStorage.setItem('krd_students_v3', JSON.stringify(students));
                            localStorage.setItem('krd_records_v3', JSON.stringify(records));
                            updateClassDropdown(); renderStudentList(); renderGradebook();
                            alert("Data dipulihkan!");
                        }
                    }
                } catch (err) { alert("Ralat fail."); }
                input.value = '';
            }; reader.readAsText(file);
        }

        // --- Main Logic (Similar to previous, compacted) ---
        function updateClassDropdown() {
            const drop = document.getElementById('classDropdown'), printDrop = document.getElementById('printClassSelect');
            const unique = [...new Set(students.map(s => s.kls))].sort();
            const opts = unique.map(c => `<option value="${c}">${c}</option>`).join('');
            drop.innerHTML = '<option value="">Pilih Kelas...</option>' + opts;
            printDrop.innerHTML = '<option value="all">SEMUA KELAS</option>' + opts;
        }
        function loadStudentsByClass() {
            const kls = document.getElementById('classDropdown').value, drop = document.getElementById('studentDropdown');
            if(!kls) { drop.innerHTML = '<option value="">Pilih Murid...</option>'; return; }
            drop.innerHTML = '<option value="">Pilih Murid...</option>' + students.filter(s => s.kls === kls).sort((a,b)=>a.name.localeCompare(b.name)).map(s => `<option value="${s.name}">${s.name}</option>`).join('');
        }
        function selectStudentFromList() {
            const name = document.getElementById('studentDropdown').value, kls = document.getElementById('classDropdown').value;
            if(!name) { activeStudent = null; updateStudentUI(); return; }
            activeStudent = students.find(s => s.name === name && s.kls === kls);
            updateStudentUI();
        }
        function updateStudentUI() {
            const d = document.getElementById('studentDetail'), p = document.getElementById('noStudentText'), i = document.getElementById('activeStudentInfo');
            if(activeStudent) { d.classList.remove('hidden'); p.classList.add('hidden'); i.classList.remove('hidden'); document.getElementById('dispName').innerText = activeStudent.name; document.getElementById('dispClass').innerText = activeStudent.kls; }
            else { d.classList.add('hidden'); p.classList.remove('hidden'); i.classList.add('hidden'); }
        }
        function addBulkStudents() {
            const raw = document.getElementById('bulkInput').value; if(!raw) return;
            raw.split('\n').forEach(l => { const p = l.split(','); if(p.length>=2) students.push({name:p[0].trim(), kls:p[1].trim().toUpperCase()}); });
            localStorage.setItem('krd_students_v3', JSON.stringify(students));
            updateClassDropdown(); renderStudentList(); document.getElementById('bulkInput').value='';
        }
        function renderStudentList() {
            const l = document.getElementById('studentListContainer');
            l.innerHTML = students.length ? '' : '<p class="text-center text-gray-300 py-6 text-[10px]">TIADA DATA</p>';
            [...students].reverse().slice(0,50).forEach((s, idx) => {
                const d = document.createElement('div'); d.className = "flex justify-between p-3 bg-white border shadow-sm rounded-xl mb-2";
                d.innerHTML = `<div><p class="font-bold text-sm">${s.name}</p><p class="text-[10px] text-gray-500">${s.kls}</p></div><button onclick="removeStudent(${students.length-1-idx})" class="text-red-500 font-black">√ó</button>`;
                l.appendChild(d);
            });
        }
        function removeStudent(idx) { students.splice(idx, 1); localStorage.setItem('krd_students_v3', JSON.stringify(students)); updateClassDropdown(); renderStudentList(); }
        function renderGradebook() {
            const l = document.getElementById('gradebookList');
            l.innerHTML = records.length ? '' : '<p class="text-center text-gray-300 py-6 text-[10px]">TIADA REKOD</p>';
            [...records].reverse().forEach(r => {
                const d = document.createElement('div'); d.className = "p-3 bg-indigo-50 border rounded-xl mb-2";
                d.innerHTML = `<p class="font-bold text-xs">${r.name}</p><p class="text-[10px]">Sifir ${r.sifir} | Skor ${r.score} | ${r.time}s</p>`;
                l.appendChild(d);
            });
        }
        function clearAllData() { if(confirm("Padam semua?")) { students=[]; records=[]; localStorage.clear(); updateClassDropdown(); renderStudentList(); renderGradebook(); } }

        function setMode(mode) { currentMode = mode; document.getElementById('scoreCard').classList.toggle('hidden', mode === 'learn'); resetApp(); }
        function selectSifir(num) { 
            currentSifir = num; resetTimer(); 
            document.querySelectorAll('.sifir-btn').forEach(b => b.classList.remove('border-indigo-600', 'bg-indigo-100'));
            document.getElementById(`sifir-${num}`).classList.add('border-indigo-600', 'bg-indigo-100');
            renderWheel(num);
        }
        function renderWheel(num) {
            const w = document.getElementById('wheelWrapper'); w.innerHTML = '';
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg"); svg.setAttribute("viewBox", "0 0 400 400"); svg.classList.add("w-full","h-full");
            for(let i=0; i<10; i++) {
                const a = i*36-90, rad = ((a+18)*Math.PI)/180;
                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", createArcPath(200,200,85,175,a,a+36));
                path.setAttribute("fill", "white"); path.setAttribute("stroke", "#e0e7ff"); path.setAttribute("stroke-width", "3");
                path.onclick = () => handleSegmentClick(i+1);
                
                const txt = document.createElementNS("http://www.w3.org/2000/svg", "text");
                txt.setAttribute("x", 200+Math.cos(rad)*65); txt.setAttribute("y", 200+Math.sin(rad)*65);
                txt.setAttribute("text-anchor", "middle"); txt.setAttribute("alignment-baseline", "middle");
                txt.textContent = i+1; txt.classList.add("font-black", "fill-indigo-900", "pointer-events-none");
                
                const ans = document.createElementNS("http://www.w3.org/2000/svg", "text");
                ans.setAttribute("x", 200+Math.cos(rad)*135); ans.setAttribute("y", 200+Math.sin(rad)*135+5);
                ans.setAttribute("text-anchor", "middle");
                ans.textContent = "??"; ans.id = `ans-${i+1}`; ans.classList.add("font-bold", "fill-gray-300", "pointer-events-none");
                
                svg.append(path, txt, ans);
            }
            const c = document.createElementNS("http://www.w3.org/2000/svg", "circle"); c.setAttribute("cx",200); c.setAttribute("cy",200); c.setAttribute("r",40); c.setAttribute("fill","#4f46e5");
            const ct = document.createElementNS("http://www.w3.org/2000/svg", "text"); ct.setAttribute("x",200); ct.setAttribute("y",206); ct.setAttribute("text-anchor","middle"); ct.setAttribute("fill","white"); ct.textContent = `${num}√ó`; ct.classList.add("font-black","text-2xl");
            svg.append(c, ct); w.appendChild(svg);
        }
        function handleSegmentClick(m) {
            if(currentMode==='practice' && !timerInterval && score.total===0) startTimer();
            activeMultiplier = m; currentSubStep = 1; updateLearnUI();
        }
        function updateLearnUI() {
            const res = currentSifir * activeMultiplier;
            const ans = document.getElementById(`ans-${activeMultiplier}`);
            if(currentMode === 'learn') {
                ans.textContent = res; ans.classList.replace('fill-gray-300','fill-indigo-900');
            } else {
                const userAns = prompt("Jawapan?");
                if(parseInt(userAns) === res) { ans.textContent = res; ans.classList.replace('fill-gray-300','fill-emerald-600'); score.correct++; }
                score.total++; document.getElementById('currentScore').innerText = `${score.correct}/${score.total}`;
            }
        }
        function createArcPath(x,y,r1,r2,a1,a2) {
            const rad1=a1*Math.PI/180, rad2=a2*Math.PI/180;
            return `M ${x+Math.cos(rad1)*r2} ${y+Math.sin(rad1)*r2} A ${r2} ${r2} 0 0 1 ${x+Math.cos(rad2)*r2} ${y+Math.sin(rad2)*r2} L ${x+Math.cos(rad2)*r1} ${y+Math.sin(rad2)*r1} A ${r1} ${r1} 0 0 0 ${x+Math.cos(rad1)*r1} ${y+Math.sin(rad1)*r1} Z`;
        }
        function startTimer() { if(!timerInterval) { const s = Date.now(); timerInterval = setInterval(() => { const t = Math.floor((Date.now()-s)/1000); document.getElementById('timerDisplay').innerText = t; }, 1000); } }
        function resetTimer() { clearInterval(timerInterval); timerInterval=null; if(document.getElementById('timerDisplay')) document.getElementById('timerDisplay').innerText="00:00"; }
        function resetApp() { currentSifir=null; score={correct:0,total:0}; resetTimer(); if(document.getElementById('wheelWrapper')) document.getElementById('wheelWrapper').innerHTML = `<span class="text-gray-300 font-black">Pilih Sifir</span>`; }
        function openLCDMode() { 
            document.getElementById('lcdModal').classList.remove('hidden'); 
            resetLcdCountdown(); 
        }
        function closeLCDMode() { document.getElementById('lcdModal').classList.add('hidden'); }
        function startLcdCountdown() { 
            if(lcdCountdownInterval) return; 
            
            // Handle Custom Time
            const select = document.getElementById('lcdTimeSelect');
            if (select.value === 'custom') {
                const customVal = document.getElementById('lcdCustomTime').value;
                if (!customVal || customVal <= 0) return alert("Sila masukkan masa yang sah.");
                lcdTimeLeft = customVal * 60;
            } else if (lcdTimeLeft <= 0 || lcdTimeLeft === 600) {
                // If reset or default, update based on dropdown
                lcdTimeLeft = parseInt(select.value);
            }

            document.getElementById('lcdStartBtn').innerText = "BERHENTI";
            document.getElementById('lcdStartBtn').onclick = pauseLcdCountdown;

            lcdCountdownInterval = setInterval(() => { 
                lcdTimeLeft--; 
                
                const m = Math.floor(lcdTimeLeft / 60).toString().padStart(2, '0');
                const s = (lcdTimeLeft % 60).toString().padStart(2, '0');
                document.getElementById('lcdTimerDisplay').innerText = `${m}:${s}`;
                
                if(lcdTimeLeft<=0) {
                    clearInterval(lcdCountdownInterval);
                    lcdCountdownInterval = null;
                    alert("MASA TAMAT!");
                    resetLcdCountdown();
                }
            }, 1000); 
        }
        
        function pauseLcdCountdown() {
            clearInterval(lcdCountdownInterval);
            lcdCountdownInterval = null;
            document.getElementById('lcdStartBtn').innerText = "SAMBUNG";
            document.getElementById('lcdStartBtn').onclick = startLcdCountdown;
        }

        function resetLcdCountdown() { 
            clearInterval(lcdCountdownInterval); 
            lcdCountdownInterval=null; 
            
            const select = document.getElementById('lcdTimeSelect');
            if(select.value === 'custom') {
                 // reset to 0 or keep input? Let's reset display to input
                 const val = document.getElementById('lcdCustomTime').value || 10;
                 lcdTimeLeft = val * 60;
                 const m = Math.floor(lcdTimeLeft / 60).toString().padStart(2, '0');
                 document.getElementById('lcdTimerDisplay').innerText = `${m}:00`;
            } else {
                lcdTimeLeft = parseInt(select.value);
                const m = Math.floor(lcdTimeLeft / 60).toString().padStart(2, '0');
                document.getElementById('lcdTimerDisplay').innerText = `${m}:00`;
            }
            
            document.getElementById('lcdStartBtn').innerText = "MULA";
            document.getElementById('lcdStartBtn').onclick = startLcdCountdown;
        }

        // Toggle custom time input
        document.getElementById('lcdTimeSelect').addEventListener('change', function() {
            const customInput = document.getElementById('lcdCustomTime');
            if (this.value === 'custom') {
                customInput.classList.remove('hidden');
            } else {
                customInput.classList.add('hidden');
                lcdTimeLeft = parseInt(this.value);
                const m = Math.floor(lcdTimeLeft / 60).toString().padStart(2, '0');
                document.getElementById('lcdTimerDisplay').innerText = `${m}:00`;
            }
        });

        function openStudentManager() { document.getElementById('studentModal').classList.remove('hidden'); renderStudentList(); renderGradebook(); }
        function closeStudentManager() { document.getElementById('studentModal').classList.add('hidden'); }
        function toggleScanner() { 
            const m = document.getElementById('scannerModal'); 
            if(!m.classList.contains('hidden')) { if(html5QrCode) html5QrCode.stop(); m.classList.add('hidden'); }
            else { m.classList.remove('hidden'); html5QrCode = new Html5Qrcode("reader"); html5QrCode.start({facingMode:"environment"}, {fps:10,qrbox:250}, (t)=>{ 
                if(t.startsWith("LOGIN:")) { const p = t.replace("LOGIN:","").split("|"); activeStudent={name:p[0],kls:p[1]}; toggleScanner(); updateStudentUI(); }
            }); }
        }
        function generateTestByClass() {
            const cls = document.getElementById('printClassSelect').value;
            const target = cls === 'all' ? students : students.filter(s => s.kls === cls);
            if(!target.length) return alert("Tiada data.");
            
            const p = document.getElementById('printArea'); 
            p.innerHTML = '';
            
            // Wait for DOM updates then print
            // We need to render QR codes one by one
            
            let htmlContent = '';
            
            target.forEach((s, index) => {
                // Generate unique ID for QR container
                const qrId = `qrcode-${index}`;
                
                htmlContent += `
                <div class="page-break p-10 border-4 border-gray-200 m-4 rounded-3xl">
                    <div class="flex justify-between items-start border-b-4 border-black pb-6 mb-8">
                        <div>
                            <h1 class="text-5xl font-black mb-2 tracking-tighter">CIRCULOX</h1>
                            <p class="text-2xl font-bold uppercase">${s.name}</p>
                            <p class="text-xl text-gray-600 font-bold uppercase">${s.kls}</p>
                        </div>
                        <div class="flex flex-col items-center">
                            <div id="${qrId}" class="border-4 border-black p-2 bg-white"></div>
                            <p class="text-xs font-bold mt-1">SCAN UNTUK REKOD</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-8">
                `;
                
                // Add Sifir 2-9 grids
                for(let i=2; i<=9; i++) {
                    const wheelHtml = `
                    <div class="flex flex-col items-center border-2 border-gray-300 rounded-3xl p-4">
                        <div class="relative w-40 h-40">
                            <svg viewBox="0 0 400 400" class="w-full h-full">
                                <!-- Paths for wheel -->
                                ${Array.from({length:10}, (_, j) => {
                                    const a = j*36-90, rad = ((a+18)*Math.PI)/180;
                                    return `<path d="${createArcPath(200,200,85,175,a,a+36)}" fill="none" stroke="black" stroke-width="4" />
                                            <text x="${200+Math.cos(rad)*65}" y="${200+Math.sin(rad)*65}" text-anchor="middle" font-size="24" font-weight="900" alignment-baseline="middle">${j+1}</text>
                                            <text x="${200+Math.cos(rad)*112}" y="${200+Math.sin(rad)*115}" text-anchor="middle" font-size="20" fill="#ccc">____</text>`;
                                }).join('')}
                                <circle cx="200" cy="200" r="40" fill="none" stroke="black" stroke-width="4" />
                                <text x="200" y="208" text-anchor="middle" font-size="30" font-weight="900">${i}√ó</text>
                            </svg>
                        </div>
                        <p class="font-black text-xl mt-2">SIFIR ${i}</p>
                    </div>`;
                    htmlContent += wheelHtml;
                }
                
                htmlContent += `
                    </div>
                    <div class="mt-8 pt-4 border-t-4 border-black flex justify-between font-black text-xl">
                        <p>TARIKH: ____________</p>
                        <p>SKOR: _____ / 80</p>
                        <p>MASA: _________</p>
                    </div>
                </div>`;
            });
            
            p.innerHTML = htmlContent;
            
            // Generate QRs after HTML insertion
            setTimeout(() => {
                target.forEach((s, index) => {
                    const qrContainer = document.getElementById(`qrcode-${index}`);
                    if(qrContainer) {
                        new QRCode(qrContainer, {
                            text: `LOGIN:${s.name}|${s.kls}`,
                            width: 100,
                            height: 100
                        });
                    }
                });
                
                // Small delay for QR rendering before print
                setTimeout(() => window.print(), 500);
            }, 100);
        }

        // Init
        updateClassDropdown(); renderStudentList(); renderGradebook(); resetApp();
    </script>
</body>
</html>
