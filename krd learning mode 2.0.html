<!doctype html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- PWA Meta Tags -->
    <title>Kit Roda Darab PdP Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RodaDarab">
    <meta name="theme-color" content="#4f46e5">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap');

        :root {
            --primary: #4f46e5;
            --secondary: #10b981;
            --accent: #f59e0b;
            --bg-gradient: linear-gradient(135deg, #e0e7ff 0%, #f3e8ff 100%);
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: #1f2937;
            font-size: 1.1rem;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        /* LCD Optimization */
        .lcd-text-shadow {
            text-shadow: 0 4px 10px rgba(79, 70, 229, 0.2);
        }

        .animate-fade-up {
            animation: fadeInUp 0.5s ease-out forwards;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.96);
            backdrop-filter: blur(12px);
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 15px 50px rgba(31, 38, 135, 0.12);
        }

        .mnl-active {
            background: #4f46e5 !important;
            color: white !important;
            transform: scale(1.25);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.4);
            z-index: 20;
        }

        .step-box {
            border-left: 8px solid #4f46e5;
            background: #ffffff;
            padding: 1.75rem;
            border-radius: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            animation: fadeInUp 0.4s ease-out;
        }

        .wheel-label, .ans-label {
            pointer-events: none;
            font-weight: 900;
        }

        .sector-highlight {
            stroke: #4f46e5;
            stroke-width: 6;
            fill: #f5f7ff !important;
        }

        /* LCD Mode Styles */
        .lcd-timer {
            font-size: clamp(5rem, 15vw, 14rem);
            line-height: 0.9;
            font-weight: 900;
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.2));
        }

        /* Responsive Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #c7d2fe; border-radius: 10px; }

        @media print {
            body > *:not(#printArea) { display: none !important; }
            #printArea { display: block !important; position: absolute; left: 0; top: 0; width: 100%; color: black; }
            .no-print { display: none !important; }
            .page-break { page-break-after: always; }
        }

        #reader {
            width: 100% !important;
            border: none !important;
            border-radius: 2rem;
            overflow: hidden;
        }
    </style>
</head>
<body class="p-3 md:p-8">

    <div class="max-w-[1600px] mx-auto no-print">
        <!-- Header Section - More Spacing for LCD -->
        <div class="text-center mb-12 md:mb-16 animate-fade-up">
            <h1 class="text-5xl md:text-7xl font-black text-indigo-700 mb-3 tracking-tight lcd-text-shadow">Kit Roda Darab</h1>
            <p class="text-xl md:text-2xl text-indigo-500 font-bold uppercase tracking-[0.1em]">Sistem Rekod Prestasi & PdP Pintar</p>
            
            <div class="flex flex-wrap justify-center gap-3 md:gap-6 mt-10">
                <button onclick="toggleLang()" id="langBtn" class="bg-white px-6 py-4 rounded-full shadow-lg border-2 border-indigo-100 hover:bg-indigo-50 transition font-black text-indigo-600 text-base flex items-center gap-2">
                    üá≤üáæ Bahasa Melayu
                </button>
                <button onclick="openStudentManager()" class="bg-emerald-600 text-white px-8 py-4 rounded-full shadow-2xl hover:bg-emerald-700 transition font-black flex items-center gap-3 text-lg">
                    üë• Pengurusan Rekod
                </button>
                <button onclick="toggleScanner()" class="bg-amber-500 text-white px-8 py-4 rounded-full shadow-2xl hover:bg-amber-600 transition font-black flex items-center gap-3 text-lg">
                    üì∑ Imbas Kertas
                </button>
                <button onclick="openLCDMode()" class="bg-indigo-950 text-white px-8 py-4 rounded-full shadow-2xl hover:bg-black transition font-black flex items-center gap-3 text-lg">
                    üñ•Ô∏è Mod Cabaran LCD
                </button>
            </div>
        </div>

        <!-- Main Dashboard Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            
            <!-- Side Controls: Left Panel -->
            <div class="lg:col-span-4 space-y-8 animate-fade-up" style="animation-delay: 0.1s">
                
                <!-- Sesi Aktif Card -->
                <div class="glass-card p-8 rounded-[2.5rem] border-b-[10px] border-indigo-500">
                    <h3 class="text-xs font-black text-gray-400 uppercase mb-5 tracking-widest text-center">Status Sesi PdP</h3>
                    <div id="activeStudentDisplay" class="p-6 bg-indigo-50 rounded-3xl border-2 border-indigo-100 min-h-[120px] flex flex-col justify-center text-center transition-all">
                        <p class="text-gray-400 font-bold italic text-lg" id="noStudentText">Sila imbas atau pilih murid</p>
                        <div id="studentDetail" class="hidden">
                            <p class="text-4xl font-black text-indigo-700 leading-tight" id="dispName"></p>
                            <p class="text-2xl font-bold text-indigo-400 mt-1" id="dispClass"></p>
                        </div>
                    </div>
                </div>

                <!-- Mod & Sifir Selection -->
                <div class="glass-card p-8 rounded-[2.5rem] space-y-10">
                    <div>
                        <h3 class="text-xs font-black text-gray-400 uppercase mb-5 tracking-widest">Tukar Mod Interaksi</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <button onclick="setMode('learn')" id="btnLearn" class="py-5 rounded-2xl font-black text-xl border-2 border-indigo-600 bg-indigo-600 text-white shadow-xl transition-all hover:scale-105 active:scale-95">Belajar</button>
                            <button onclick="setMode('practice')" id="btnPractice" class="py-5 rounded-2xl font-black text-xl border-2 border-indigo-100 text-indigo-600 hover:bg-indigo-50 transition-all hover:scale-105 active:scale-95">Latihan</button>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xs font-black text-gray-400 uppercase mb-5 tracking-widest">Pilih Sifir Utama</h3>
                        <div class="grid grid-cols-3 gap-3">
                            <script>
                                for(let i=1; i<=9; i++) {
                                    document.write(`<button onclick="selectSifir(${i})" id="sifir-${i}" class="sifir-btn h-16 rounded-2xl font-black text-2xl border-2 border-gray-100 hover:border-indigo-400 transition-all text-gray-600 bg-white shadow-md">${i}</button>`);
                                }
                            </script>
                        </div>
                    </div>
                </div>

                <!-- Score Board (Practice Mode) -->
                <div id="scoreCard" class="glass-card p-8 rounded-[2.5rem] hidden bg-white border-emerald-500 border-b-[10px] animate-fade-up">
                    <div class="flex justify-between items-center mb-6">
                        <span class="font-black text-emerald-700 text-2xl">Skor</span>
                        <span class="text-5xl font-black text-emerald-600" id="currentScore">0/0</span>
                    </div>
                    <div class="flex justify-between items-center bg-emerald-50 p-5 rounded-3xl border-2 border-emerald-100">
                        <span class="text-sm font-black text-emerald-600 uppercase">PEMASA DIGITAL</span>
                        <span class="text-4xl font-mono font-black text-emerald-700" id="timerDisplay">00:00</span>
                    </div>
                </div>

                <button onclick="resetApp()" class="w-full py-6 rounded-[2rem] font-black text-xl text-gray-400 bg-gray-100 hover:bg-gray-200 hover:text-gray-600 transition-all border-2 border-gray-200 shadow-sm" id="btnReset">Set Semula Semua</button>
            </div>

            <!-- Right Content: Interactive Wheel & Scaffolding -->
            <div class="lg:col-span-8 space-y-8 animate-fade-up" style="animation-delay: 0.2s">
                
                <!-- Magic Number Line Visualization -->
                <div class="glass-card p-8 rounded-[2.5rem] overflow-x-auto border-t-[10px] border-indigo-100">
                    <h3 class="text-center font-black text-indigo-400 mb-8 text-sm uppercase tracking-widest">Garis Nombor Ajaib (Magic Number Line)</h3>
                    <div class="flex justify-between items-center px-4 min-w-[600px] md:min-w-0">
                        <script>
                            const mnlLabels = ["+1", "+2", "+3", "+4", "¬±5", "-4", "-3", "-2", "-1"];
                            for(let i=1; i<=9; i++) {
                                document.write(`
                                    <div id="mnl-${i}" class="z-10 w-12 h-12 md:w-16 md:h-16 rounded-full bg-white border-4 border-gray-100 flex flex-col items-center justify-center transition-all duration-500">
                                        <span class="text-base md:text-xl font-black">${i}</span>
                                        <span class="text-[10px] md:text-xs font-black text-indigo-500">${mnlLabels[i-1]}</span>
                                    </div>
                                `);
                            }
                        </script>
                    </div>
                </div>

                <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 items-start">
                    <!-- Interactive SVG Wheel -->
                    <div class="flex flex-col items-center justify-center">
                        <div id="wheelWrapper" class="relative w-full aspect-square max-w-[500px] bg-white rounded-full shadow-inner border-8 border-dashed border-indigo-50 flex items-center justify-center mx-auto transition-transform hover:scale-[1.02]">
                            <span class="text-gray-300 font-black text-center p-10 text-2xl uppercase tracking-tighter">Pilih Sifir</span>
                        </div>
                    </div>

                    <!-- Scaffolding Guide Panel -->
                    <div id="guidePanel" class="glass-card p-10 rounded-[3rem] min-h-[550px] border-l-[15px] border-indigo-500 flex flex-col shadow-2xl transition-all">
                        <div id="guideContent" class="flex-grow overflow-y-auto">
                            <!-- Injected Steps -->
                        </div>
                        <div id="guideActions" class="mt-8 flex flex-col gap-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: LCD / Countdown Mode -->
    <div id="lcdModal" class="fixed inset-0 bg-indigo-950 hidden z-[100] flex flex-col items-center justify-center p-6 md:p-12 overflow-hidden">
        <div class="w-full max-w-7xl text-center space-y-10 md:space-y-20">
            <h2 class="text-indigo-300 text-2xl md:text-5xl font-black uppercase tracking-[0.4em] lcd-text-shadow">Cabaran Kelas Sifir 2-9</h2>
            
            <div class="flex flex-col items-center">
                <div id="lcdTimerDisplay" class="lcd-timer text-white font-mono">10:00</div>
                <div class="flex flex-wrap justify-center gap-6 mt-16 no-print">
                    <button id="lcdStartBtn" onclick="startLcdCountdown()" class="px-16 py-8 bg-emerald-500 text-white rounded-[2rem] font-black text-3xl md:text-5xl shadow-[0_20px_60px_rgba(16,185,129,0.4)] hover:bg-emerald-600 hover:scale-105 active:scale-95 transition-all">MULA</button>
                    <button onclick="resetLcdCountdown()" class="px-16 py-8 bg-indigo-800 text-indigo-100 rounded-[2rem] font-black text-3xl md:text-5xl shadow-2xl hover:bg-indigo-700 transition-all">RESET</button>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="p-8 bg-indigo-900/40 rounded-[2.5rem] border-2 border-indigo-800">
                    <p class="text-indigo-400 font-bold uppercase text-sm mb-4">Masa Sasaran</p>
                    <select id="lcdTimeSelect" class="bg-transparent text-white text-4xl md:text-6xl font-black outline-none cursor-pointer w-full text-center">
                        <option value="300" class="text-black">5 MIN</option>
                        <option value="600" class="text-black" selected>10 MIN</option>
                        <option value="900" class="text-black">15 MIN</option>
                        <option value="1200" class="text-black">20 MIN</option>
                    </select>
                </div>
                <div class="p-8 bg-indigo-900/40 rounded-[2.5rem] border-2 border-indigo-800 col-span-1 md:col-span-3 text-center">
                    <p class="text-indigo-400 font-bold uppercase text-sm mb-4">Peserta Aktif</p>
                    <p id="lcdStudentName" class="text-white text-4xl md:text-7xl font-black tracking-tighter uppercase truncate">SEMUA MURID</p>
                </div>
            </div>

            <button onclick="closeLCDMode()" class="absolute top-8 right-8 text-indigo-500 hover:text-white text-5xl md:text-7xl font-black no-print transition-colors">√ó</button>
        </div>
    </div>

    <!-- OTHER MODALS (Student Manager, Scanner, Entry) -->
    <div id="studentModal" class="fixed inset-0 bg-black/90 backdrop-blur-xl hidden z-50 flex flex-col items-center justify-center p-4">
        <div class="glass-card w-full max-w-5xl p-8 md:p-12 rounded-[3.5rem] animate-fade-up max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-10">
                <h2 class="text-4xl md:text-5xl font-black text-indigo-700">Database Murid</h2>
                <button onclick="closeStudentManager()" class="text-gray-400 hover:text-red-500 text-5xl font-black">√ó</button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                <div class="space-y-8">
                    <div class="p-8 bg-gray-50 rounded-[2.5rem] border-4 border-white shadow-inner">
                        <h3 class="font-black text-indigo-600 mb-6 uppercase text-sm tracking-widest">Daftar Murid</h3>
                        <div class="space-y-5 text-center">
                            <input type="text" id="addName" placeholder="Nama Penuh" class="w-full px-6 py-4 rounded-2xl border-2 border-gray-200 outline-none font-bold text-xl">
                            <input type="text" id="addClass" placeholder="Kelas" class="w-full px-6 py-4 rounded-2xl border-2 border-gray-200 outline-none font-bold text-xl">
                            <button onclick="addStudent()" class="w-full py-5 bg-indigo-600 text-white rounded-2xl font-black text-xl shadow-xl hover:bg-indigo-700">Simpan Murid</button>
                        </div>
                    </div>
                    <div id="studentList" class="space-y-3 overflow-y-auto max-h-[300px] pr-2"></div>
                </div>
                <div class="p-8 bg-white border-8 border-indigo-50 rounded-[3rem]">
                    <h3 class="font-black text-emerald-600 mb-6 uppercase text-sm tracking-widest text-center">Buku Rekod Markah Kertas</h3>
                    <div id="gradebookList" class="space-y-3 overflow-y-auto max-h-[400px]"></div>
                    <button onclick="clearAllData()" class="w-full mt-6 text-xs text-red-300 font-bold uppercase tracking-widest hover:text-red-500 transition-colors">Padam Semua Data Rekod</button>
                </div>
            </div>
            <button onclick="generateTestForAll()" class="w-full mt-12 py-6 bg-emerald-600 text-white rounded-3xl font-black text-2xl shadow-2xl hover:bg-emerald-700">Cetak Semua Lembaran Kerja (QR)</button>
        </div>
    </div>

    <div id="scannerModal" class="fixed inset-0 bg-black/95 backdrop-blur-md hidden z-50 flex flex-col items-center justify-center p-6">
        <div class="glass-card w-full max-w-xl p-8 rounded-[3rem] animate-fade-up text-center border-t-[15px] border-amber-500">
            <h2 class="text-3xl font-black text-indigo-700 mb-6 uppercase tracking-tighter">Detect Lembaran Murid</h2>
            <div id="reader"></div>
            <p class="mt-6 text-sm font-black text-gray-400 uppercase tracking-widest">Halakan kamera pada Kod QR di kertas murid</p>
            <button onclick="toggleScanner()" class="mt-8 py-5 px-12 bg-gray-100 text-gray-600 rounded-3xl font-black text-xl hover:bg-gray-200">Tutup Kamera</button>
        </div>
    </div>

    <div id="entryModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm hidden z-[60] flex items-center justify-center p-4">
        <div class="glass-card w-full max-w-lg p-10 rounded-[3.5rem] animate-fade-up border-indigo-600 border-t-[20px] shadow-2xl">
            <h2 class="text-3xl font-black text-indigo-700 mb-2">Perekodan Manual</h2>
            <p id="entryStudentInfo" class="text-gray-500 font-bold mb-8 text-lg"></p>
            <div class="space-y-8 text-center">
                <div>
                    <label class="block text-xs font-black text-gray-400 uppercase mb-4 tracking-widest">Pilih Sifir</label>
                    <div class="grid grid-cols-5 gap-2" id="entrySifirGrid"></div>
                </div>
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs font-black text-gray-400 uppercase mb-3">Markah (/10)</label>
                        <input type="number" id="entryScore" min="0" max="10" class="w-full px-6 py-5 rounded-2xl border-4 border-gray-100 font-black text-4xl text-center outline-none focus:border-indigo-400 transition-colors">
                    </div>
                    <div>
                        <label class="block text-xs font-black text-gray-400 uppercase mb-3">Masa (Saat)</label>
                        <input type="number" id="entryTime" placeholder="45" class="w-full px-6 py-5 rounded-2xl border-4 border-gray-100 font-black text-4xl text-center outline-none focus:border-indigo-400 transition-colors">
                    </div>
                </div>
                <button onclick="saveEntry()" class="w-full py-6 bg-indigo-600 text-white rounded-3xl font-black text-2xl shadow-xl hover:bg-indigo-700">Simpan Ke Rekod</button>
                <button onclick="closeEntryModal()" class="w-full py-2 text-gray-400 font-bold uppercase text-xs">Batal</button>
            </div>
        </div>
    </div>

    <!-- Hidden Print Container -->
    <div id="printArea" class="hidden bg-white"></div>

    <script>
        // --- Init & State ---
        let currentSifir = null, currentMode = 'learn', lang = 'ms';
        let score = { correct: 0, total: 0 }, activeMultiplier = null, currentSubStep = 0;
        let timerInterval = null, timeElapsed = 0, html5QrCode = null;
        let students = JSON.parse(localStorage.getItem('krd_students_v2') || '[]');
        let records = JSON.parse(localStorage.getItem('krd_records_v2') || '[]');
        let activeStudent = null, scanTargetSifir = 1;
        let lcdCountdownInterval = null, lcdTimeLeft = 600;

        const krdActions = {
            1: { val: 1, type: 'plus', display: '+1' }, 2: { val: 2, type: 'plus', display: '+2' },
            3: { val: 3, type: 'plus', display: '+3' }, 4: { val: 4, type: 'plus', display: '+4' },
            5: { val: 5, type: 'both', display: '¬±5' }, 6: { val: 4, type: 'minus', display: '-4' },
            7: { val: 3, type: 'minus', display: '-3' }, 8: { val: 2, type: 'minus', display: '-2' },
            9: { val: 1, type: 'minus', display: '-1' }
        };

        // --- Core UI Functions ---
        function setMode(mode) {
            currentMode = mode;
            document.getElementById('btnLearn').className = mode === 'learn' ? 'py-5 rounded-2xl font-black text-xl border-2 border-indigo-600 bg-indigo-600 text-white shadow-xl' : 'py-5 rounded-2xl font-black text-xl border-2 border-indigo-100 text-indigo-600 hover:bg-indigo-50';
            document.getElementById('btnPractice').className = mode === 'practice' ? 'py-5 rounded-2xl font-black text-xl border-2 border-emerald-600 bg-emerald-600 text-white shadow-xl' : 'py-5 rounded-2xl font-black text-xl border-2 border-indigo-100 text-indigo-600 hover:bg-indigo-50';
            document.getElementById('scoreCard').classList.toggle('hidden', mode === 'learn');
            resetApp();
        }

        function selectSifir(num) {
            currentSifir = num; resetTimer();
            document.querySelectorAll('.sifir-btn').forEach(b => b.classList.remove('border-indigo-600', 'bg-indigo-100', 'text-indigo-600', 'scale-105'));
            const btn = document.getElementById(`sifir-${num}`); if(btn) btn.classList.add('border-indigo-600', 'bg-indigo-100', 'text-indigo-600', 'scale-105');
            document.querySelectorAll('[id^="mnl-"]').forEach(m => m.classList.remove('mnl-active'));
            const mnl = document.getElementById(`mnl-${num}`); if(mnl) mnl.classList.add('mnl-active');
            renderWheel(num);
            document.getElementById('guideContent').innerHTML = `<div class="text-center mt-10 md:mt-20"><h2 class="text-6xl md:text-8xl font-black text-indigo-700 leading-none">SIFIR ${num}</h2><p class="text-xl md:text-2xl font-bold text-gray-400 mt-6 uppercase tracking-[0.3em] animate-pulse">Sedia Untuk Bermula</p></div>`;
            document.getElementById('guideActions').innerHTML = "";
        }

        function renderWheel(num) {
            const wrapper = document.getElementById('wheelWrapper'); wrapper.innerHTML = '';
            const size = 500, center = 250, svgNS = "http://www.w3.org/2000/svg";
            const svg = document.createElementNS(svgNS, "svg"); svg.setAttribute("viewBox", `0 0 500 500`); svg.classList.add("w-full", "h-full");
            for (let i = 0; i < 10; i++) {
                const angle = 36, startA = i*angle-90, endA = (i+1)*angle-90, pathData = createArcPath(center, center, 110, 240, startA, endA);
                const g = document.createElementNS(svgNS, "g"); g.classList.add("cursor-pointer"); g.onclick = () => handleSegmentClick(i+1);
                const sector = document.createElementNS(svgNS, "path"); sector.setAttribute("d", pathData); sector.setAttribute("fill", "white"); sector.setAttribute("stroke", "#e5e7eb"); sector.setAttribute("stroke-width", "3");
                sector.id = `sector-${i+1}`; sector.classList.add("transition-all", "hover:fill-indigo-50");
                const rad = ((startA + 18) * Math.PI) / 180;
                const tx = center + Math.cos(rad) * 85, ty = center + Math.sin(rad) * 85;
                const label = document.createElementNS(svgNS, "text"); label.setAttribute("x", tx); label.setAttribute("y", ty); label.setAttribute("text-anchor", "middle"); label.setAttribute("alignment-baseline", "middle");
                label.classList.add("wheel-label", "text-[26px]", "fill-indigo-900"); label.textContent = i+1;
                const px = center + Math.cos(rad) * 180, py = center + Math.sin(rad) * 180;
                const ans = document.createElementNS(svgNS, "text"); ans.setAttribute("x", px); ans.setAttribute("y", py+10); ans.setAttribute("text-anchor", "middle");
                ans.classList.add("ans-label", "text-[28px]", "fill-gray-200"); ans.id = `ans-${i+1}`; ans.textContent = "??";
                g.appendChild(sector); g.appendChild(label); g.appendChild(ans); svg.appendChild(g);
            }
            const c = document.createElementNS(svgNS, "circle"); c.setAttribute("cx", center); c.setAttribute("cy", center); c.setAttribute("r", 55); c.setAttribute("fill", "#4f46e5");
            const ct = document.createElementNS(svgNS, "text"); ct.setAttribute("x", center); ct.setAttribute("y", center+10); ct.setAttribute("text-anchor", "middle"); ct.classList.add("fill-white", "font-black", "text-[32px]");
            ct.textContent = `${num}√ó`; svg.appendChild(c); svg.appendChild(ct); wrapper.appendChild(svg);
        }

        // --- LCD Mode Functions ---
        function openLCDMode() { document.getElementById('lcdModal').classList.remove('hidden'); document.getElementById('lcdStudentName').innerText = activeStudent ? activeStudent.name.toUpperCase() : "SEMUA MURID"; resetLcdCountdown(); }
        function closeLCDMode() { document.getElementById('lcdModal').classList.add('hidden'); resetLcdCountdown(); }
        function startLcdCountdown() {
            if(lcdCountdownInterval) { clearInterval(lcdCountdownInterval); lcdCountdownInterval = null; document.getElementById('lcdStartBtn').innerText = "TERUSKAN"; return; }
            const select = document.getElementById('lcdTimeSelect'); if(lcdTimeLeft <= 0) lcdTimeLeft = parseInt(select.value);
            document.getElementById('lcdStartBtn').innerText = "BERHENTI";
            lcdCountdownInterval = setInterval(() => { lcdTimeLeft--; updateLcdDisplay(); if(lcdTimeLeft <= 0) { clearInterval(lcdCountdownInterval); lcdCountdownInterval = null; alert("MASA TAMAT!"); resetLcdCountdown(); } }, 1000);
        }
        function resetLcdCountdown() { clearInterval(lcdCountdownInterval); lcdCountdownInterval = null; const select = document.getElementById('lcdTimeSelect'); lcdTimeLeft = parseInt(select.value); updateLcdDisplay(); document.getElementById('lcdStartBtn').innerText = "MULA CABARAN"; }
        function updateLcdDisplay() { const m = Math.floor(lcdTimeLeft/60).toString().padStart(2, '0'), s = (lcdTimeLeft%60).toString().padStart(2, '0'); document.getElementById('lcdTimerDisplay').innerText = `${m}:${s}`; }

        // --- Data Management ---
        function openStudentManager() { document.getElementById('studentModal').classList.remove('hidden'); renderStudentList(); renderGradebook(); }
        function closeStudentManager() { document.getElementById('studentModal').classList.add('hidden'); }
        function renderStudentList() {
            const list = document.getElementById('studentList'); list.innerHTML = students.length ? '' : '<p class="text-center text-gray-300 py-10 font-bold uppercase text-xs">Database Kosong</p>';
            students.forEach((s, idx) => {
                const div = document.createElement('div'); div.className = "flex justify-between items-center p-5 bg-white rounded-3xl border-2 border-gray-100 shadow-sm transition-transform hover:scale-[1.01]";
                div.innerHTML = `<div class="text-left leading-tight"><p class="font-black text-indigo-900 text-lg">${s.name}</p><p class="text-xs font-bold text-gray-400 uppercase">${s.kls}</p></div><button onclick="removeStudent(${idx})" class="text-red-300 font-black text-3xl hover:text-red-500">√ó</button>`;
                list.appendChild(div);
            });
        }
        function addStudent() {
            const n = document.getElementById('addName').value, k = document.getElementById('addClass').value; if(!n || !k) return;
            students.push({ name: n, kls: k }); localStorage.setItem('krd_students_v2', JSON.stringify(students));
            document.getElementById('addName').value = ''; document.getElementById('addClass').value = ''; renderStudentList();
        }
        function removeStudent(idx) { students.splice(idx, 1); localStorage.setItem('krd_students_v2', JSON.stringify(students)); renderStudentList(); }
        function renderGradebook() {
            const list = document.getElementById('gradebookList'); list.innerHTML = records.length ? '' : '<p class="text-center text-gray-300 py-10 font-bold uppercase text-xs">Tiada Rekod</p>';
            [...records].reverse().forEach((r) => {
                const div = document.createElement('div'); div.className = "p-4 bg-indigo-50 border-2 border-indigo-100 rounded-2xl flex justify-between items-center";
                div.innerHTML = `<div class="text-left leading-tight"><p class="font-black text-indigo-900 text-sm">${r.name}</p><p class="text-[10px] font-bold text-indigo-400 uppercase tracking-tighter">Sifir ${r.sifir} | Skor: ${r.score}/10 | Masa: ${r.time}s</p></div><span class="text-[10px] font-black text-indigo-300">${r.date}</span>`;
                list.appendChild(div);
            });
        }
        function clearAllData() { if(confirm("Tindakan ini akan memadam SEMUA rekod dan data murid. Teruskan?")) { students=[]; records=[]; localStorage.clear(); renderStudentList(); renderGradebook(); }}

        // --- Detection & Auto Entry ---
        function toggleScanner() {
            const modal = document.getElementById('scannerModal');
            if (!modal.classList.contains('hidden')) { if (html5QrCode) html5QrCode.stop().then(() => html5QrCode = null); modal.classList.add('hidden'); }
            else {
                modal.classList.remove('hidden'); html5QrCode = new Html5Qrcode("reader");
                html5QrCode.start({ facingMode: "environment" }, { fps: 15, qrbox: 280 }, (text) => {
                    if(text.startsWith("LOGIN:")) {
                        const parts = text.replace("LOGIN:", "").split("|"); activeStudent = { name: parts[0], kls: parts[1] };
                        toggleScanner(); openEntryModal();
                    }
                }).catch(() => { alert("Akses kamera gagal."); toggleScanner(); });
            }
        }
        function openEntryModal() {
            if(!activeStudent) return; document.getElementById('entryModal').classList.remove('hidden');
            document.getElementById('entryStudentInfo').innerText = `${activeStudent.name.toUpperCase()} (${activeStudent.kls.toUpperCase()})`;
            const g = document.getElementById('entrySifirGrid'); g.innerHTML = "";
            for(let i=1; i<=9; i++) {
                const b = document.createElement('button'); b.className = `p-4 rounded-2xl font-black text-xl border-2 transition-all ${scanTargetSifir==i?'bg-indigo-600 text-white border-indigo-600 shadow-lg scale-110':'bg-white text-gray-500 border-gray-100 hover:border-indigo-200'}`;
                b.innerText = i; b.onclick = () => { scanTargetSifir = i; openEntryModal(); }; g.appendChild(b);
            }
        }
        function closeEntryModal() { document.getElementById('entryModal').classList.add('hidden'); }
        function saveEntry() {
            const s = document.getElementById('entryScore').value, t = document.getElementById('entryTime').value; if(!s || !t) return alert("Sila isikan markah dan masa.");
            records.push({ name: activeStudent.name, kls: activeStudent.kls, sifir: scanTargetSifir, score: s, time: t, date: new Date().toLocaleDateString('ms-MY', {day:'2-digit', month:'short'}) });
            localStorage.setItem('krd_records_v2', JSON.stringify(records));
            document.getElementById('studentDetail').classList.remove('hidden'); document.getElementById('noStudentText').classList.add('hidden');
            document.getElementById('dispName').innerText = activeStudent.name; document.getElementById('dispClass').innerText = activeStudent.kls;
            closeEntryModal(); alert("Rekod prestasi berjaya disimpan!");
        }

        // --- Helpers & Visual Logic ---
        function createArcPath(x, y, innerR, outerR, startAngle, endAngle) {
            const sR = startAngle * Math.PI / 180, eR = endAngle * Math.PI / 180;
            return `M ${x+Math.cos(sR)*outerR} ${y+Math.sin(sR)*outerR} A ${outerR} ${outerR} 0 0 1 ${x+Math.cos(eR)*outerR} ${y+Math.sin(eR)*outerR} L ${x+Math.cos(eR)*innerR} ${y+Math.sin(eR)*innerR} A ${innerR} ${innerR} 0 0 0 ${x+Math.cos(sR)*innerR} ${y+Math.sin(sR)*innerR} Z`;
        }
        function startTimer() { if (timerInterval) return; let sT = Date.now(); timerInterval = setInterval(() => { timeElapsed = Math.floor((Date.now()-sT)/1000); const m = Math.floor(timeElapsed/60).toString().padStart(2,'0'), s = (timeElapsed%60).toString().padStart(2,'0'); document.getElementById('timerDisplay').innerText = `${m}:${s}`; }, 1000); }
        function resetTimer() { clearInterval(timerInterval); timerInterval = null; timeElapsed = 0; if(document.getElementById('timerDisplay')) document.getElementById('timerDisplay').innerText = "00:00"; }
        function resetApp() { currentSifir = null; score = { correct: 0, total: 0 }; document.getElementById('currentScore').innerText = "0/0"; resetTimer(); document.getElementById('wheelWrapper').innerHTML = `<span class="text-gray-300 font-black text-center p-12 text-3xl uppercase tracking-widest leading-tight">Pilih Sifir Utama</span>`; document.getElementById('guideContent').innerHTML = `<div class="text-center mt-12"><h2 class="text-4xl font-black text-indigo-700 tracking-widest uppercase mb-6">Panduan Kit Roda</h2><p class="text-xl font-bold text-gray-400">Gunakan paparan ini sebagai alat bantu mengajar visual untuk murid menguasai teknik MNL.</p></div>`; document.getElementById('guideActions').innerHTML = ""; }
        function toggleLang() { lang = lang === 'ms' ? 'en' : 'ms'; resetApp(); }
        function handleSegmentClick(m) {
            if(currentMode === 'practice' && !timerInterval && score.total === 0) startTimer();
            activeMultiplier = m; document.querySelectorAll('path').forEach(p => p.classList.remove('sector-highlight'));
            const s = document.getElementById(`sector-${m}`); if(s) s.classList.add('sector-highlight');
            if(currentMode === 'learn') { currentSubStep = 1; updateLearnUI(); } else { startPracticeUI(); }
        }
        function updateLearnUI() {
            const m = activeMultiplier, res = currentSifir * m, prevSa = (currentSifir * (m-1)) % 10, currSa = res % 10, action = krdActions[currentSifir];
            let content = `<h2 class="text-5xl font-black text-indigo-700 mb-8 text-center">${currentSifir} √ó ${m}</h2>`;
            if(currentSubStep >= 1) content += `<div class="step-box shadow-lg"><p class="text-xs font-black text-amber-600 uppercase mb-3 text-center tracking-widest underline">Langkah 1: Cari Sa</p><div class="flex items-center justify-center gap-6"><span class="text-3xl font-black">${prevSa}</span><span class="text-3xl font-black text-indigo-600">${action.display}</span><span class="text-5xl font-black text-amber-700">‚ûî ${currSa}</span></div></div>`;
            if(currentSubStep >= 2) content += `<div class="step-box shadow-lg"><p class="text-xs font-black text-indigo-600 uppercase mb-3 text-center tracking-widest underline">Langkah 2: Cari Puluh</p><p class="text-2xl font-black text-indigo-800 text-center">${(prevSa > currSa && m > 1) ? "Sa Menurun: Puluh +1" : "Sa Naik/Sama: Puluh Kekal"}</p></div>`;
            if(currentSubStep === 3) {
                const ans = document.getElementById(`ans-${m}`); ans.textContent = res < 10 ? `0${res}` : res; ans.classList.replace('fill-gray-200', 'fill-indigo-600');
                content += `<div class="mt-8 p-10 bg-indigo-600 text-white rounded-[2.5rem] text-center shadow-2xl animate-fade-up"><p class="text-sm font-bold uppercase opacity-70 mb-2">JAWAPAN AKHIR</p><p class="text-7xl font-black">${res}</p></div>`;
                document.getElementById('guideActions').innerHTML = `<button onclick="selectSifir(${currentSifir})" class="w-full py-6 bg-gray-100 rounded-3xl font-black text-2xl text-gray-500 hover:bg-indigo-50 hover:text-indigo-600 transition-all">Teruskan Seterusnya!</button>`;
            } else { document.getElementById('guideActions').innerHTML = `<button onclick="currentSubStep++; updateLearnUI();" class="w-full py-6 bg-indigo-600 text-white rounded-3xl font-black text-2xl shadow-2xl hover:scale-105 transition-all">${currentSubStep === 1 ? "Langkah Seterusnya" : "Lihat Jawapan Akhir"}</button>`; }
            document.getElementById('guideContent').innerHTML = content;
        }
        function startPracticeUI() {
            const currSa = (currentSifir * activeMultiplier) % 10;
            document.getElementById('guideContent').innerHTML = `<h2 class="text-3xl font-black text-emerald-700 mb-8 text-center uppercase tracking-widest">Berapakah nilai Sa?</h2><div class="grid grid-cols-5 gap-3">${[0,1,2,3,4,5,6,7,8,9].map(i => `<button onclick="checkSa(${i}, ${currSa})" class="h-20 bg-white border-4 border-emerald-100 rounded-3xl font-black text-4xl shadow-md hover:bg-emerald-50 transition-all">${i}</button>`).join('')}</div>`;
            document.getElementById('guideActions').innerHTML = "";
        }
        function checkSa(val, correct) {
            if(val === correct) { const prevSa = (currentSifir * (activeMultiplier-1)) % 10, correctRule = (prevSa > correct && activeMultiplier > 1) ? 'A' : 'B'; score.correct++; updatePracticeRuleUI(correctRule); }
            else alert("Jawapan Sa kurang tepat. Sila gunakan aksi MNL!");
            score.total++; document.getElementById('currentScore').innerText = `${score.correct}/${score.total}`;
        }
        function updatePracticeRuleUI(correct) {
            document.getElementById('guideContent').innerHTML = `<h2 class="text-3xl font-black text-emerald-700 mb-8 text-center uppercase tracking-widest">Pilih Peraturan Puluh?</h2><div class="grid grid-cols-1 gap-4"><button onclick="checkRule('A', '${correct}')" class="py-6 bg-white border-4 border-emerald-100 rounded-[2rem] font-black text-xl text-emerald-700 shadow-md uppercase hover:bg-emerald-50">A (Menurun: +1)</button><button onclick="checkRule('B', '${correct}')" class="py-6 bg-white border-4 border-emerald-100 rounded-[2rem] font-black text-xl text-emerald-700 shadow-md uppercase hover:bg-emerald-50">B (Naik/Sama: Kekal)</button></div>`;
        }
        function checkRule(val, correct) {
            if(val === correct || activeMultiplier === 1) {
                const res = currentSifir * activeMultiplier;
                const ans = document.getElementById(`ans-${activeMultiplier}`); ans.textContent = res < 10 ? `0${res}` : res; ans.classList.replace('fill-gray-200', 'fill-emerald-600');
                document.getElementById('guideContent').innerHTML = `<div class="text-center py-10 animate-fade-up"><p class="text-9xl font-black text-emerald-600 leading-none">${res}</p><p class="mt-8 text-3xl font-black text-emerald-500 uppercase tracking-[0.2em]">TEPAT SEKALI!</p></div>`;
                document.getElementById('guideActions').innerHTML = `<button onclick="nextPractice()" class="w-full py-6 bg-emerald-500 text-white rounded-3xl font-black text-2xl shadow-2xl">Pilih Seterusnya</button>`;
                score.correct++;
            } else alert("Peraturan tidak tepat!");
            score.total++; document.getElementById('currentScore').innerText = `${score.correct}/${score.total}`;
        }
        function nextPractice() {
            let answered = 0; for(let i=1; i<=10; i++) { if(document.getElementById(`ans-${i}`).textContent !== "??") answered++; }
            if (answered === 10) finishPractice();
            else { document.getElementById('guideContent').innerHTML = `<div class="flex flex-col items-center justify-center min-h-[350px]"><p class="text-3xl font-black text-gray-300 text-center uppercase tracking-[0.2em] leading-relaxed">Sila tekan segmen<br>seterusnya pada roda...</p></div>`; document.getElementById('guideActions').innerHTML = ""; }
        }
        function finishPractice() {
            resetTimer(); const n = activeStudent ? activeStudent.name : "Murid", k = activeStudent ? activeStudent.kls : "Tiada", data = `STUDENT:${n}|CLASS:${k}|SCORE:${score.correct}/${score.total}`;
            const qr = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(data)}`;
            document.getElementById('guideContent').innerHTML = `<div class="text-center animate-fade-up"><h2 class="text-3xl font-black text-indigo-700 mb-6 uppercase">Sesi Latihan Tamat!</h2><div class="flex justify-center mb-6"><img src="${qr}" class="w-48 h-48 border-8 border-white shadow-2xl rounded-3xl"></div><div class="text-left bg-indigo-50 p-6 rounded-[2rem] border-2 border-indigo-100"><p class="text-2xl font-black text-indigo-800 leading-tight">${n}</p><p class="font-bold text-indigo-500 text-lg uppercase">${k}</p></div></div>`;
            document.getElementById('guideActions').innerHTML = `<button onclick="resetApp()" class="w-full py-6 bg-indigo-600 text-white rounded-3xl font-black text-xl">Latihan Baru</button>`;
        }

        // --- Print Generator 2-9 ---
        function generateTestForAll() {
            if(!students.length) return alert("Sila daftar murid terlebih dahulu.");
            const p = document.getElementById('printArea'); p.innerHTML = "";
            students.forEach((s) => {
                const pg = document.createElement('div'); pg.className = "p-10 page-break";
                const qr = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent("LOGIN:"+s.name+"|"+s.kls)}`;
                let h = `<div class="flex justify-between items-start border-b-8 border-black pb-8 mb-10"><div><h1 class="text-6xl font-black tracking-tighter">KIT RODA DARAB</h1><p class="text-4xl font-bold mt-6 tracking-tight uppercase">NAMA: ${s.name}</p><p class="text-3xl font-bold uppercase">KELAS: ${s.kls}</p></div><div class="text-center"><img src="${qr}" class="w-36 h-36 border-4 border-black p-1 shadow-sm"><p class="text-[10px] font-black mt-3 uppercase tracking-widest">Scan Untuk Rekod</p></div></div><div class="grid grid-cols-3 gap-10">`;
                for(let sf=2; sf<=9; sf++) {
                    h += `<div class="border-4 border-black p-4 rounded-[3.5rem] flex flex-col items-center"><svg viewBox="0 0 320 320" class="w-full h-auto">${Array.from({length:10}, (_, i) => { const a = i*36-90, r = ((a + 18) * Math.PI) / 180; return `<path d="${createArcPath(160,160,80,140,a,a+36)}" fill="none" stroke="black" stroke-width="4" /><text x="${160+Math.cos(r)*65}" y="${160+Math.sin(r)*65}" text-anchor="middle" font-size="22" font-weight="900" alignment-baseline="middle">${i+1}</text><text x="${160+Math.cos(r)*112}" y="${160+Math.sin(r)*115}" text-anchor="middle" font-size="14" fill="#ddd">____</text>`; }).join('')}<circle cx="160" cy="160" r="30" fill="none" stroke="black" stroke-width="4" /><text x="160" y="168" text-anchor="middle" font-size="24" font-weight="900">${sf}√ó</text></svg><p class="mt-4 font-black text-2xl">SIFIR ${sf}</p></div>`;
                }
                pg.innerHTML = h + `</div><div class="mt-16 flex justify-end gap-12 font-black text-2xl italic uppercase border-t-4 border-black pt-8"><span>Markah: _____ / 80</span><span>Masa: _________</span></div>`; p.appendChild(pg);
            }); window.print();
        }

        resetApp();
    </script>
</body>
</html>
